# Javaæ¨¡ç»„å¼€å‘å­¦ä¹ è®¡åˆ’2024.07

## Gradleæ„å»ºå·¥å…· ã€å­¦ä¹ æˆæœ¬ç›¸å¯¹é«˜ã€‘

### é›¶ï¼Œè®¤è¯†é˜¶æ®µ

1. äº†è§£Antã€Mavenã€Gradleçš„æœ¬è´¨åŠå„è‡ªçš„ä¼˜ç¼ºç‚¹

   å¯ä»¥ä»**ä»¥ä¸‹è§’åº¦**æ¥è¿›è¡Œæ¨ªå‘å¯¹æ¯”

   * æ„å»ºæ€§èƒ½é«˜ä½

   * ä»“åº“

   * ä¾èµ–æ”¯æŒ

   * æ’ä»¶æ”¯æŒ

   * æ˜¯å¦éµå¾ªç‰¹å®šç›®å½•ç»“æ„

   * é…ç½®æ–‡ä»¶ç¼–å†™éš¾æ˜“åº¦

   * é¡¹ç›®ä¾§é‡ç‚¹

   * ç›®å‰åœ°ä½


2. Gradleé¡¹ç›®ç›®å½•ç»“æ„

     * åŸºäºCovention Over Configuration
     * ä¸Mavené¡¹ç›®ç»“æ„å¤§ä½“å·®ä¸å¤š

3. Gradleä¸­å¸¸ç”¨æŒ‡ä»¤

|   å¸¸è§çš„GradleæŒ‡ä»¤   |            ä½œç”¨            |
| :------------------: | :------------------------: |
|     gradle clean     |       æ¸…ç©ºbuildç›®å½•        |
|    gradle classes    |  ç¼–è¯‘ä¸šåŠ¡ä»£ç ä½•å’Œé…ç½®æ–‡ä»¶  |
|     gradle test      | ç¼–è¯‘æµ‹è¯•ä»£ç ï¼Œç”Ÿæˆæµ‹è¯•æŠ¥é“ |
|     gradle build     |          æ„å»ºé¡¹ç›®          |
| gradle build -x test |        è·³è¿‡æµ‹è¯•æ„å»º        |

*gradleæŒ‡ä»¤è¦åœ¨å«build.gradleçš„é¡¹ç›®ç›®å½•ä¸‹æ‰§è¡Œ

4. Gradle WrapperåŒ…è£…å™¨
   * ç†è§£å…¶åœ¨æ•´ä¸ªé¡¹ç›®ä¸­çš„ä½œç”¨
   * ä»€ä¹ˆæ—¶å€™é€‚åˆä½¿ç”¨åŒ…è£…å™¨ã€å®˜æ–¹ä¸ºä»€ä¹ˆæ¨èä½¿ç”¨å…¶ã€‘

### ä¸€,  Gradleä¸IDEAç»“åˆé˜¶æ®µ

 1. #### Groovyç¼–ç¨‹è¯­è¨€

    * ä¸€ç§æˆç†Ÿé¢å‘å¯¹è±¡çš„ç¼–ç¨‹è¯­è¨€ï¼ˆæ—¢èƒ½ç”¨äºé¢å‘å¯¹è±¡ç¼–ç¨‹ï¼Œä¹Ÿå¯ä»¥çº¯ç²¹ä½œä¸ºè„šæœ¬è¯­è¨€ç¼–ç¨‹ï¼‰

    * å¯è¢«è§†ä½œä¸ºJavaçš„ä¸€ç§è„šæœ¬åŒ–æ”¹è‰¯ç‰ˆ

    * å¯è¿è¡Œåœ¨JVMä¸Š

    * è‰¯å¥½çš„ä¸Javaä»£ç åŠå…¶ç›¸å…³åº“è¿›è¡Œäº¤äº’æ“ä½œ

      > [!TIP]
      >
      > å¤§å¤šæ•°æœ‰æ•ˆçš„Javaä»£ç å¯ä»¥è¢«è½¬åŒ–ä¸ºæœ‰æ•ˆçš„Groovyä»£ç ï¼Œ
      >
      > åè€…ä¸å‰ç½®çš„ä¸»è¦åŒºåˆ«åœ¨äºå®Œæˆç›¸åŒçš„ä»»åŠ¡æ‰€éœ€è¦çš„ä»£ç é‡æ›´å°‘

      **ç‰¹ç‚¹:**

      1. åŠŸèƒ½å¼ºå¤§ ã€æ”¯æŒåŠ¨æ€ç±»å‹è½¬æ¢ã€é—­åŒ…å’Œå…ƒç¼–ç¨‹(metaprogramming)ã€‘

      2. æ”¯æŒå‡½æ•°å¼ç¼–ç¨‹ï¼Œæ— éœ€mainå‡½æ•°

      3. é»˜è®¤å¯¼å…¥å¸¸ç”¨çš„åŒ…

      4. ç±»ä¸æ”¯æŒdefaultä½œç”¨åŸŸï¼Œé»˜è®¤ä½œç”¨åŸŸä¸ºpublic

      5. Groovyä¸­åŸºæœ¬ç±»å‹ä¹Ÿæ˜¯å¯¹è±¡ï¼Œå¯ä»¥ç›´æ¥è°ƒç”¨å¯¹è±¡çš„æ–¹æ³•

      6. æ”¯æŒDSL(Domain Specific Languages é¢†åŸŸç‰¹å®šè¯­è¨€) å’Œå…¶å®ƒç®€æ´çš„è¯­æ³•, è®©ä»£ç å˜å¾—æ˜“äºé˜…è¯»å’Œç»´æŠ¤

      7. GroovyåŸºäºJavaè¯­è¨€çš„ï¼Œæ‰€ä»¥æ˜¯å®Œå…¨å…¼å®¹Javaè¯­æ³•ï¼Œå› æ­¤å¯¹äºJavaç¨‹åºå‘˜å­¦ä¹ æˆæœ¬è¾ƒä½ 

         **è¯¦ç»†äº†è§£è¯·å‚è€ƒ** [[Groovy Language Documentation (groovy-lang.org)](https://docs.groovy-lang.org/latest/html/documentation/)]

         ç±»ä¼¼äºPythonäºJavaçš„ç»“åˆ

         å­¦ä¹ å…¶è¯­æ³•

         * å­—ç¬¦ä¸²å­—ç¬¦ä¸² ps å¯¹äºåŒå¼•å·ç±»å‹""æ”¯æŒ$å˜é‡è¿ç®—èƒ½åŠ›ï¼Œæ­¤æ—¶å­—ç¬¦ä¸²ç±»å‹ä¸ºGString
         * è¯­å¥ç»“æ„
         * æ•°æ®ç»“æ„
         * ç±»å‹åŠæƒé™ä¿®é¥°ç¬¦
         * é›†åˆæ“ä½œ
         * ç±»å¯¼å…¥
         * å¼‚å¸¸å¤„ç†
         * é—­åŒ…ï¼ˆClosureï¼‰

    2. #### Grettyæ’ä»¶

    3. #### build.gradleé…ç½®æ–‡ä»¶ç¼–å†™

       1. Gradleçš„ä»»åŠ¡å…¥é—¨ä¸ä»»åŠ¡è¡Œä¸º
    
          1. task å®šä¹‰ ï¼ˆMap<String, ?>ï¼ŒString ï¼ŒClosureï¼‰
          2. taskçš„doFirstã€doLastè¡Œä¸ºã€å¤–ç½®.doFirst ä¸å†…éƒ¨ doFirstæ‰§è¡Œé¡ºåºæ³¨æ„ã€‘
    
       2. Gradleä»»åŠ¡çš„ä¾èµ–è¡Œä¸ºdependOn
    
       3. Gradleä»»åŠ¡åˆ†ç»„(group)
    
       4. Gradleä»»åŠ¡å®šä¹‰çš„æ–¹å¼
    
          1. task()æ–¹å¼
          2. task.register()æ–¹å¼ å»¶è¿Ÿåˆ›å»º
    
       5. GradleæŒ‡å®šä»»åŠ¡çš„å±æ€§
    
          ä»»åŠ¡çš„å±æ€§ï¼š
    
          1. type (Task) ç±»ä¼¼äºç»§æ‰¿
          2. overwrite (Boolean) æ˜¯å¦æ›¿æ¢å­˜åœ¨çš„Task
          3. dependsOn (TaskList[])ä»»åŠ¡çš„ä¾èµ–
          4. action æ·»åŠ ä»»åŠ¡ä¸­çš„Actionæˆ–é—­åŒ…
          5. description
          6. group
    
          å®šä¹‰çš„æ–¹å¼ 
    
          1. å…·åå‚æ•° task(group: "åˆ†ç»„å")
          1. å†…éƒ¨ç›´æ¥æŒ‡å®š group("åˆ†ç»„å")
          1. å¤–éƒ¨æŒ‡å®š xxx.group = "åˆ†ç»„å"
    
    
    
    â€‹	

## Java è¿›é˜¶ç¼–ç¨‹

1. I/Oæ“ä½œ

    1. BIOï¼ˆBLOCKING I/Oï¼‰C10Kã€C10Mï¼ˆConnectï¼‰é—®é¢˜

    2. NIO ï¼ˆNON-BLOCKING I/Oï¼‰  æ•ˆç‡ä¸é«˜ï¼ˆå ç”¨CPUï¼‰-> NIOå¤šè·¯å¤ç”¨å™¨ï¼ˆä¸€ä¸ªçº¿ç¨‹å¤šå¤„ç†ï¼‰

       â€‹	é€šè¿‡Epollï¼ˆã€Linuxã€‘åŸºäºCè¯­è¨€å’Œæ“ä½œç³»ç»Ÿå†…æ ¸å‡½æ•°ï¼‰äº‹ä»¶è½®è¯¢æœºåˆ¶

       Redisçº¿ç¨‹æ¨¡å‹ ï¼Œ**Nettyçº¿ç¨‹æ¨¡å‹**ï¼ˆå¯¹NIOè¿›è¡Œäº†å¤§é‡ä¼˜åŒ–ï¼Œå¯ä»¥æ”¯æŒç™¾ä¸‡è¿æ¥ï¼‰

2. Javaç¼–ç¨‹è®¾è®¡æ¨¡å¼
   1. é“¾å¼ç¼–ç¨‹

   2. å·¥å‚è®¾è®¡æ¨¡å¼


3. å¹¶å‘ç¼–ç¨‹æ€æƒ³
4. å…¶å®ƒjavaåº“ï¼ˆæ•°å­¦è®¡ç®—ã€å›¾å½¢ç»˜åˆ¶ç­‰ç­‰)

### <font color="red">**NIO**</font>

#### 1. ä¸‰å¤§ç»„ä»¶

##### 1.1 Channel & Buffer

Channel  æœ‰ç‚¹ç±»ä¼¼äº streamï¼Œå®ƒæ˜¯è¯»å†™çš„**åŒå‘é€šé“**ï¼Œå¯ä»¥ä» channel ä¸­å°†æ•°æ®è¯»å…¥ bufferï¼Œä¹Ÿå¯ä»¥å°† buffer çš„æ•°æ®å†™å…¥åˆ° channel ä¸­

> [!NOTE]
>
> streamè¦ä¹ˆæ˜¯è¾“å…¥ï¼Œè¦ä¹ˆæ˜¯è¾“å‡ºï¼Œå› æ­¤channel æ¯” stream æ›´ä¸ºåº•å±‚



```mermaid
stateDiagram
 direction LR
   Channel --> Buffer
   Buffer --> Channel

```

å¸¸è§çš„ Channel æœ‰

* FileChannel
* DatagramChannel
* SocketChannel
* ServerSocketChannel

buffer åˆ™ç”¨æ¥ç¼“å†²è¯»å†™æ•°æ®ï¼Œå¸¸è§çš„ buffer æœ‰

* ByteBuffer
  * MappedByteBuffer
  * DirectByteBuffer
  * HeapByteBuffer
* ShortBuffer
* IntBuffer
* LongBuffer
* FloatBuffer
* DoubleBuffer
* CharBuffer

##### 1.2 Selector

éœ€ç»“åˆæœåŠ¡å™¨çš„è®¾è®¡æ¼”åŒ–æ¥ç†è§£

**å¤šçº¿ç¨‹ç‰ˆè®¾è®¡**

````mermaid
stateDiagram-v2
state å¤šçº¿ç¨‹ç‰ˆ {
   Thread01 --> socket1
   Thread02 --> socket2
   Thread03 --> socket3
   }
````

å¤šçº¿ç¨‹ç‰ˆæœåŠ¡å™¨è®¾è®¡ç¼ºç‚¹: 1.å†…å­˜å ç”¨é«˜ `C10M`  2.çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢æˆæœ¬é«˜ 3.ä¸é€‚åˆå¤§é‡è¿æ¥æ•°æƒ…å†µ

**çº¿ç¨‹æ± ç‰ˆè®¾è®¡**

````mermaid
flowchart LR
subgraph çº¿ç¨‹æ± ç‰ˆ
   Thread01 --> socket1
   Thread01 -.-> socket2
   Thread02 --> socket3
   Thread02 -.-> socket4
end
   
````

çº¿ç¨‹æ± ç‰ˆæœåŠ¡å™¨è®¾è®¡ç¼ºç‚¹: 1.é˜»å¡æ¨¡å¼ä¸‹ï¼Œä¸€ä¸ªçº¿ç¨‹åªèƒ½å¤„ç†ä¸€ä¸ªSocketè¿æ¥ 2.ä»…é€‚ç”¨çŸ­è¿æ¥åœºæ™¯ï¼ˆå³è¿æ¥å»ºç«‹åå³æ—¶é€šè®¯ï¼‰

**selector ç‰ˆè®¾è®¡**

seletor çš„ä½œç”¨å°±æ˜¯é…åˆä¸€ä¸ªçº¿ç¨‹æ¥ç®¡ç†å¤šä¸ª channel ï¼Œè·å–è¿™äº› channel ä¸Šå‘ç”Ÿçš„äº‹ä»¶ï¼Œ è¿™äº› channel å·¥ä½œåœ¨**éé˜»å¡**æ¨¡å¼ä¸‹ï¼Œ ä¸ä¼šè®©çº¿ç¨‹åŠæ­»åœ¨ä¸€ä¸ª channel ä¸Šã€‚ é€‚åˆè¿æ¥æ•°ç‰¹åˆ«å¤šï¼Œä½†æµé‡ä½çš„åœºæ™¯ï¼ˆlow trafficï¼‰

````mermaid
flowchart LR
subgraph selector ç‰ˆ
Thread --> selector
selector --> channel1
selector --> channel2
selector --> channel3
end
````

è°ƒç”¨ selector çš„`selector()`ä¼šé˜»å¡ç›´åˆ° channel å‘é€äº†è¯»å†™å°±ç»ªäº‹ä»¶ï¼Œè¿™äº›äº‹ä»¶å‘é€ï¼Œselectoræ–¹æ³•å°±ä¼šè¿”å›è¿™äº›äº‹ä»¶äº¤ç»™ thread æ¥å¤„ç† ï¼ˆåŸºäºæ“ä½œç³»ç»Ÿçº§åˆ«å®ç°ï¼‰

#### 2.ByteBuffer

##### 2.1å¦‚ä½•æ­£ç¡®ä½¿ç”¨

1. å‘ buffer å†™å…¥æ•°æ®ï¼Œä¾‹å¦‚è°ƒç”¨ channel.read(buffer)
1. è°ƒç”¨ flip() åˆ‡æ¢åˆ° **è¯»æ¨¡å¼**
1.  ä» buffer è¯»å–æ•°æ®ï¼Œä¾‹å¦‚è°ƒç”¨ buffer.get()
1. è°ƒç”¨ clear() æˆ– compact() åˆ‡æ¢è‡³ **å†™æ¨¡å¼**
1. é‡å¤ 1~4 æ­¥éª¤

##### 2.2ByteBufferç»“æ„ 

å‡ ä¸ªé‡è¦å±æ€§ã€åˆ†åˆ«ç†è§£åˆå§‹çŠ¶æ€ã€å†™æ¨¡å¼å†™å…¥çŠ¶æ€ã€flipåŠ¨ä½œå˜åŒ–ã€clearåŠ¨ä½œå˜åŒ–ã€compactåŠ¨ä½œå˜åŒ–ï¼ˆä»æŒ‡é’ˆè§’åº¦ç†è§£ï¼‰ã€‘

* capacity
* position
* limitï¼ˆè¯»ï¼Œå†™ï¼‰ 

##### 2.3 ByteBufferå¸¸è§æ–¹æ³•

1. åˆ†é…ç©ºé—´ ByteBuffer.allocate(int)ã€allocateDirectï¼ˆintï¼‰

   ä¸¤è€…è¿”å›ç±»å‹ä¸åŒ å‰è€…ä½¿ç”¨çš„æ˜¯Javaå †å†…å­˜HeapByteBufferã€åè€…æ˜¯ç›´æ¥å†…å­˜DirectByteBuffer

   Javaå †å†…å­˜è¯»å†™æ•ˆç‡ä½ï¼Œä¼šå— GC çš„å½±å“ ï¼›åè€…æ˜¯ç³»ç»Ÿå†…å­˜ï¼Œè¯»å†™æ•ˆç‡é«˜(å°‘ä¸€æ¬¡æ‹·è´)ï¼Œä¸å—GCçš„å½±å“ï¼Œä½†åˆ†é…å†…å­˜æ•ˆç‡ä½ä¸‹ï¼Œä½¿ç”¨ä¸å½“ä¼šæœ‰å†…å­˜æ³„æ¼ã€Nettyå¯¹æ­¤è¿›è¡Œå°è£…ï¼Œæé«˜äº†åˆ†é…æ•ˆç‡ï¼Œæ›´åŠ å®‰å…¨ã€‘

2. å‘bufferå†™å…¥&è¯»å–æ•°æ®

   1. put(xxx)å†™å…¥

   2. get(i)è¯»å–ï¼ˆiä¸ºéç©ºæ—¶ï¼ŒæŒ‡å‘ç´¢å¼•iä½ç½®ï¼Œä½†positionæŒ‡é’ˆä¸ä¼šæ”¹å˜

   3. rewind()ä»å¤´å¼€å§‹è¯»

   4. mark() & reset() mark()åšæ ‡è®°ï¼Œè®°å½• position  ä½ç½® , reset() æ˜¯å°† position  é‡ç½®åˆ°  mark çš„ä½ç½®

3. å­—ç¬¦ä¸²ä¸ByteBufferè½¬åŒ–

   1. å­—ç¬¦ä¸² -> ByteBuffer

       ```Java
       ByteBuffer buffer = ByteBuffer.allocate(16);
       buffer.put("[String]".getBytes());//è°ƒç”¨å®ŒByteBufferå¤„äºå†™æ¨¡å¼
       ```

   2. Charset

      ```Java
      ByteBuffer buffer = standardCharsets.UTF_8.encode("[String]");//è°ƒç”¨å®ŒByteBufferä¼šè‡ªåŠ¨åˆ‡æ¢è¯»æ¨¡å¼
      /**/
      String str = StandardCharsets.UTF_8.decode(buffer).toString();//å†™æ¨¡å¼è½¬ä¼šæœ‰é—®é¢˜ï¼ˆä»positionä½ç½®å‘åè½¬ï¼‰
      ```
   
   3. wrap
   
       ```Java
       ByteBuffer buffer = ByteBuffer.wrap("[String]".getBytes());//è°ƒç”¨å®ŒByteBufferä¼šè‡ªåŠ¨åˆ‡æ¢è¯»æ¨¡å¼
       ```

##### 2.4 Scattering Reads

â€‹	åˆ†æ•£è¯»å–ï¼šå°†è¦è¯»å…¥é•¿å­—ç¬¦ä¸²ç”¨å¤šä¸ªByteBufferåˆ†åˆ«è¯»å…¥ï¼ˆé‡æ€æƒ³ï¼Œè½»ä»£ç å®ç°ï¼‰

##### 2.5 Gathering Writes

â€‹	é›†ä¸­å†™å…¥ï¼šå°†å¤šä¸ªByteBufferç»„åˆåœ¨ä¸€èµ·ï¼ˆé‡æ€æƒ³ï¼Œè½»ä»£ç å®ç°ï¼‰

##### 2.6 ç²˜åŒ…/åŠåŒ…

â€‹	ç½‘ç»œä¸Šæœ‰å¤šæ¡æ•°æ®å‘å‘æœåŠ¡ç«¯ï¼Œæ•°æ®ä¹‹é—´å‡è®¾ç”¨`\n`è¿›è¡Œåˆ†éš”ï¼Œä½†å‡ºäºæŸç§åŸå› ï¼Œè¿™äº›æ•°æ®åœ¨æ¥æ”¶æ—¶ï¼Œè¢«è¿›è¡Œäº†é‡æ–°æ’åˆ—ç»„åˆï¼ŒåŸæ¥åŒ…æœ‰çš„è¢«å®Œæ•´çš„ç»„åˆåœ¨ä¸€èµ·ï¼ˆç²˜åŒ…ï¼‰ï¼Œæœ‰çš„è¢«æ‹†åˆ†æˆéƒ¨åˆ†ï¼ˆåŠåŒ…ï¼‰ï¼Œå¯ä»¥é€šè¿‡é‡åˆ°æ–¹æ³•æ¥åœ¨æœåŠ¡å™¨ç«¯é‡æ–°ç»„åˆæ’åˆ—è¿˜åŸå¥½è¿™äº›æ•°æ®åŒ…

#### 3. æ–‡ä»¶ç¼–ç¨‹

##### 3.1 FileChannel

> [!WARNING]
>
> FileChannel åªèƒ½å·¥ä½œåœ¨é˜»å¡æ¨¡å¼ä¸‹

**è·å–**

ä¸èƒ½ç›´æ¥æ‰“å¼€FileChannelï¼Œå¿…é¡»é€šè¿‡FileInputStreamã€FileOutputStreamæˆ–è€… RandomAccessFileæ¥è·å– FileChannelï¼Œå®ƒä»¬éƒ½æœ‰getChannel() æ–¹æ³•

* FileInputStream è·å–çš„ channel åªè¯»
* FileOutputStream è·å–çš„ channel åªå†™
* RandomAccessFile èƒ½å¦è¯»å†™æ ¹æ® æ„é€ çš„RandomAccessFileæ—¶çš„è¯»å†™æ¨¡å¼æ¥å†³å®šçš„

**è¯»å–**

ä¼šä» channel è¯»å–æ•°æ®å¡«å……ByteBufferï¼Œè¿”å›å€¼è¡¨ç¤ºè¯»å–åˆ°äº†å¤šå°‘å­—èŠ‚ï¼Œ-1è¡¨ç¤ºåˆ°è¾¾äº†æ–‡ä»¶çš„ç»“å°¾

```Java
int readBytes = channel.read(buffer);
```

**å†™å…¥**

å†™å…¥çš„æ­£ç¡®æ–¹å¼å¦‚ä¸‹ï¼š

```Java
ByteBuffer buffer = ... ;
buffer.put(...); //å­˜å…¥æ•°æ®
buffer.flip();   //åˆ‡æ¢è¯»æ¨¡å¼

while(buffer.hasRemaining()) {
    channel.write(buffer);
}

```

åœ¨whileä¸­è°ƒç”¨`channel.write()`æ˜¯å› ä¸ºwriteæ–¹æ³•å¹¶ä¸èƒ½ä¿è¯ä¸€æ¬¡æ€§å°†bufferä¸­çš„å†…å®¹å…¨éƒ¨å†™å…¥åˆ°channelä¸­

**å…³é—­**

channel å¿…é¡»å…³é—­ï¼Œä¸è¿‡è°ƒç”¨äº† FileInputStream ç­‰çš„ close æ–¹æ³•ä¼šé—´æ¥åœ°è°ƒç”¨ channel çš„ close æ–¹æ³• 

**ä½ç½®**

è·å¾—å½“å‰ä½ç½®

```Java
long pos = channel.position();
```

è®¾ç½®å½“å‰ä½ç½®

```Java
long newPos = ...;
channel.position(newPos);
```

è®¾ç½®å½“å‰ä½ç½®ï¼Œè‹¥è®¾ç½®ä¸ºæ–‡ä»¶çš„æœ«å°¾

* c=æ­¤æ—¶è¯»å–ä¼šè¿”å›-1
* è¿™æ—¶å†™å…¥ï¼Œä¼šè¿½åŠ å†…å®¹ï¼Œä½†è¦æ³¨æ„å¦‚æœ position è¶…è¿‡äº†æ–‡ä»¶æœ«å°¾ï¼Œå†å†™å…¥æ—¶åœ¨æ–°å†…å®¹å’ŒåŸæœ«å°¾ä¹‹é—´ä¼šæœ‰ç©ºæ´ (00)

**å¤§å°**

 ä½¿ç”¨`size()`è·å–æ–‡ä»¶çš„å¤§å°

**å¼ºåˆ¶å†™å…¥**

æ“ä½œç³»ç»Ÿå‡ºäºæ€§èƒ½çš„è€ƒè™‘ï¼Œä¼šå°†æ•°æ®ç¼“å­˜ï¼Œè€Œä¸æ˜¯ç«‹åˆ»å†™å…¥åˆ°ç£ç›˜é‡Œã€‚å¯ä»¥è°ƒç”¨ force(true) æ–¹æ³•æ¥å°†æ–‡ä»¶å†…å®¹å’Œå…ƒæ•°æ®ï¼ˆæ–‡ä»¶çš„æƒé™ç­‰ä¿¡æ¯ï¼‰ç«‹åˆ»å†™å…¥ç£ç›˜ 

##### 3.2 ä¸¤ä¸ªchannelä¼ è¾“æ•°æ®

````Java
String FROM = "è¯»å…¥æ•°æ®æ–‡ä»¶Path";
String TO = "å†™å…¥æ•°æ®æ–‡ä»¶Path";
try ( 
	FileChannel from = new FileInputStream(FROM).getChannel();
    FileChannel to = new FileOutputStream(TO).getChannel
) {
   //æ•ˆç‡æ¯”ç›´æ¥é€šè¿‡æ•°æ®æµé«˜ï¼Œåº•å±‚ä¼šç”¨æ“ä½œç³»ç»Ÿçš„é›¶æ‹·è´è¿›è¡Œä¼˜åŒ–ï¼Œä½†æœ‰ æœ€å¤§ä¸€æ¬¡ä¼ è¾“æ•°æ®é‡ä¸Šé™(è¶…å‡ºä¼šè¢«æˆªå–)
	from.tranferTo(0, from.size(), to);//position å¤§å° target    
} catch (IOException e) {
    e.printStackTrace();
}

````

æ”¹è¿›ç‰ˆ

````Java
long size = from.size();//left å˜é‡ä»£è¡¨è¿˜å‰©å¤šå°‘å­—èŠ‚
for (long left = size; left > 0 ; ) {
    left -= from.transferTo((size - left), left, to);
}
/*==========================*/
long hasWritten = 0;//hasWritten å˜é‡ä»£è¡¨å†™å…¥äº†å¤šå°‘å­—èŠ‚
while(hasWritten < from.size()) {
    hasWritten += from.transferTo(hasWritten, form.size() - hasWritten, to);
}
````

##### 3.3 Path

jdk7å¼•å…¥äº† Path å’Œ Paths ç±»ã€

* path ç”¨æ¥è¡¨ç¤ºæ–‡ä»¶è·¯å¾„
* paths æ˜¯å·¥å…·ç±»ï¼Œç”¨æ¥è·å– path å®ä¾‹

```Java
Path source = Paths.get("path");
/* 
"path":
	"1.txt" --- ç›¸å¯¹è·¯å¾„ ä½¿ç”¨user.dir ç¯å¢ƒå˜é‡æ¥å®šä½ 1.txt
	"d:\\1.txt" --- ç»å¯¹è·¯å¾„ ä»£è¡¨äº† d:\1.txt
	"d:/1.txt" --- åŒä¸Š
	"d:\\data","project" --- ä»£è¡¨ d:\data\projects
*/
```

* `.` ä»£è¡¨å½“å‰è·¯å¾„
* `..` ä»£è¡¨ä¸Šä¸€çº§ç›®å½•

````
ç¤ºä¾‹ç›®å½•ç»“æ„
d:
	| - data
		| - projects
			| - a
			| - b
````

ä»£ç 

```Java
Path path = paths.get("d:\\data\\projects\\a\\..\\b");
System.out.println(path + "\n" + path.normalize());//æ™®é€š \n æ­£å¸¸åŒ–è·¯å¾„
/* Output:
	d:\data\projects\a\..\b
	d:\data\projects\b
*/
```



##### 3.4 Files

**æ£€æŸ¥æ–‡ä»¶&è·¯å¾„ç›®å½•æ˜¯å¦å­˜åœ¨**

`Files.exists(path)`

**åˆ›å»ºä¸€çº§ç›®å½•**

`Files.createDirectory(path)`

* å¦‚æœç›®å½•å·²å­˜åœ¨ï¼Œä¼šæŠ› `FileAlreadExistsException`
* ä¸èƒ½ä¸€æ¬¡åˆ›å»ºå¤šçº§ç›®å½•ï¼Œå¦åˆ™ä¼šæŠ›å¼‚å¸¸ `NoShchFileException`

**åˆ›å»ºå¤šçº§ç›®å½•**

`Files.createDirectories(path)`

**æ‹·è´æ–‡ä»¶**

`Files.copy(source, target)`

* è‹¥æ–‡ä»¶å·²å­˜åœ¨ï¼Œåˆ™ä¼šæŠ›å¼‚å¸¸FileAlreadyExistsException

å¦‚æœå¸Œæœ›ç”¨ source è¦†ç›– target ï¼Œåˆ™éœ€è¦ç”¨StandardCopyOptionæ¥æ§åˆ¶

```Java
Files.copy(source, target, StandardCopyOption.REPLACE_EXISTING);
```

 **åˆ é™¤æ–‡ä»¶**

`Files.delete(target)`

* å¦‚æœæ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆ™ä¼šæŠ›å¼‚å¸¸  NoSuchFileException

**åˆ é™¤ç›®å½•**

`Files.delete(target)`

* è‹¥ç›®å½•é‡Œè¿˜æœ‰å†…å®¹ï¼Œä¼šæŠ›å¼‚å¸¸ DirectoryNotEmptyException

**éå†ç›®å½•æ–‡ä»¶**

```Java
package F20240703;

import java.io.IOException;
import java.nio.file.*;
import java.nio.file.attribute.BasicFileAttributes;
import java.util.concurrent.atomic.AtomicInteger;

@SuppressWarnings("preview")
public class TestFilesWalkFileTree {
    public static void main(String[] args) throws IOException {
        AtomicInteger dirCount = new AtomicInteger();
        AtomicInteger fileCount = new AtomicInteger();
        Files.walkFileTree(Paths.get("D:\\R39_s_Whimsy_NeoForgeModProject"), new SimpleFileVisitor<Path>() {
            @Override
            public FileVisitResult preVisitDirectory(Path dir, BasicFileAttributes attrs) throws IOException {
                System.out.println(STR."===>\{dir}");
                dirCount.incrementAndGet();
                return super.preVisitDirectory(dir, attrs);
            }

            @Override
            public FileVisitResult visitFile(Path file, BasicFileAttributes attrs) throws IOException {
                System.out.println(file);
                fileCount.incrementAndGet();
                return super.visitFile(file, attrs);
            }
        });
        System.out.println(STR."dirCount: \{dirCount.get()}");
        System.out.println(STR."fileCount: \{fileCount.get()}");
    }
}
```

**ç»ƒä¹ : åˆ©ç”¨æ”¹æ–¹æ³•æ¥åˆ é™¤ã€æ‹·è´å¤šé‡æ–‡ä»¶ç›®å½•**

#### 4. ç½‘ç»œç¼–ç¨‹

##### 4.1  éé˜»å¡ vs é˜»å¡

###### **é˜»å¡**

* é˜»å¡æ¨¡å¼ä¸‹ï¼Œç›¸å…³æ–¹æ³•éƒ½ä¼šå¯¼è‡´çº¿ç¨‹æš‚åœ
  * ServerSocketChannel.accept ä¼šåœ¨æ²¡æœ‰è¿æ¥å»ºç«‹æ—¶è®©çº¿ç¨‹æš‚åœ
  * SocketChannel.read ä¼šåœ¨æ²¡æœ‰æ•°æ®å¯è¯»æ—¶è®©çº¿ç¨‹æš‚åœ
  * é˜»å¡çš„è¡¨ç°å°±æ˜¯çº¿ç¨‹æš‚åœäº†ï¼Œæš‚åœæœŸé—´ä¸ä¼šå ç”¨Cpuï¼Œä½†çº¿ç¨‹ç›¸å½“äºé—²ç½®
* å•çº¿ç¨‹ä¸‹ï¼Œé˜»å¡æ–¹æ³•ä¹‹é—´ç›¸äº’å½±å“ï¼Œå‡ ä¹ä¸èƒ½æ­£å¸¸å·¥ä½œï¼Œéœ€è¦å¤šçº¿ç¨‹æ”¯æŒ
* ä½†å¤šçº¿ç¨‹ä¸‹ä¼šæœ‰æ–°çš„é—®é¢˜ï¼Œä½“ç°åœ¨ä»¥ä¸‹æ–¹é¢
  * 32ä½çš„JVM ä¸€ä¸ªçº¿ç¨‹ 320Kï¼Œ64ä½çš„JVM ä¸€ä¸ªçº¿ç¨‹1024Kï¼Œå¦‚æœè¿æ¥è¿‡å¤šï¼Œå¿…ç„¶ä¼šå¯¼è‡´OOMï¼Œè€Œä¸”çº¿ç¨‹å¤ªå¤šï¼Œåè€Œä¼šå› ä¸ºé¢‘ç¹çš„ä¸Šä¸‹æ–‡åˆ‡æ¢å¯¼è‡´æ€§èƒ½é™ä½
  * é‡‡ç”¨çº¿ç¨‹æ± é›†åˆæ¥å‡å°‘çº¿ç¨‹æ•°å’Œçº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œæ²»æ ‡ä¸æ²»æœ¬ï¼Œå¦‚æœæœ‰å¾ˆå¤šè¿æ¥å»ºç«‹ï¼Œä½†é•¿äº‹ä»¶inactiveï¼Œä¼šé˜»å¡çº¿ç¨‹æ± ä¸­çš„æ‰€æœ‰çº¿ç¨‹ï¼Œå› æ­¤ä¸é€‚åˆé•¿è¿æ¥ï¼Œåªé€‚åˆçŸ­è¿æ¥

###### **éé˜»å¡**

* éé˜»å¡æ¨¡å¼ä¸‹ï¼Œç›¸å…³æ–¹æ³•éƒ½ä¸ä¼šè®©çº¿ç¨‹æš‚åœ
  * åœ¨ServerSocketChannel.accept åœ¨æ²¡æœ‰è¿æ¥å»ºç«‹æ—¶ï¼Œä¼šè¿”å›nullï¼Œç»§ç»­è¿è¡Œ
  * SocketChannel.read åœ¨æ²¡æœ‰æ•°æ®å¯è¯»æ—¶,ä¼šè¿”å›0,ä½†çº¿ç¨‹ä¸æ¯”é˜»å¡ï¼Œå¯ä»¥å»æ‰§è¡Œå…¶å®ƒçš„SocketChannelçš„ read æˆ–æ˜¯ å»æ‰§è¡Œ ServerSocketChannel.accpet
  * å†™æ•°æ®æ—¶ï¼Œçº¿ç¨‹åªæ˜¯ç­‰å¾…æ•°æ®å†™å…¥Channelå³å¯ï¼Œæ— éœ€ç­‰ Channel é€šè¿‡ç½‘ç»œæŠŠæ•°æ®å‘é€å‡ºå»
* ä½†éé˜»å¡æ¨¡å¼ä¸‹ï¼Œå³ä½¿æ²¡æœ‰è¿æ¥å»ºç«‹ï¼Œå’Œå¯è¯»æ•°æ®ï¼Œçº¿ç¨‹ä»ç„¶ä¸æ–­è¿è¡Œï¼Œä¼šæµªè´¹Cpuæ€§èƒ½
* æ•°æ®å¤åˆ¶è¿‡ç¨‹ä¸­ï¼Œçº¿ç¨‹å®é™…ä¸Šè¿˜æ˜¯é˜»å¡çš„ (AIOæ”¹è¿›çš„åœ°æ–¹)

###### **å¤šè·¯å¤ç”¨**

å•çº¿ç¨‹å¯ä»¥é…åˆSelectorå®Œæˆå¯¹å¤šä¸ªChannel å¯è¯»å†™äº‹ä»¶çš„ç›‘æ§ï¼Œè¿™ç§°ä¹‹ä¸ºå¤šè·¯å¤ç”¨

* å¤šè·¯å¤ç”¨ä»…é’ˆå¯¹ç½‘ç»œIOï¼Œæ™®é€šæ–‡ä»¶IOæ²¡æ³•åˆ©ç”¨å¤šè·¯å¤ç”¨
* å¦‚æœä¸ç”¨Selector çš„éé˜»å¡æ¨¡å¼ï¼Œçº¿ç¨‹å¤§éƒ¨åˆ†æ—¶é—´åœ¨åšæ— ç”¨åŠŸï¼Œè€ŒSelector èƒ½å¤Ÿä¿è¯
  * æœ‰å¯è¿æ¥äº‹ä»¶æ—¶æ‰ä¼šå»è¿æ¥
  * æœ‰å¯è¯»äº‹ä»¶æ‰å»è¯»å–
  * æœ‰å¯å†™äº‹ä»¶æ‰å»å†™å…¥
    * é™äºç½‘ç»œä¼ è¾“èƒ½åŠ›ï¼ŒChannelæœªå¿…å®æ—¶å¯å†™ï¼Œä¸€æ—¦Channelå¯å†™ï¼Œä¼šè§¦å‘Selectorçš„å¯å†™äº‹ä»¶

é˜»å¡ -> éé˜»å¡ ä¹‹é—´çš„é—®é¢˜ -> Selectorå¤šè·¯å¤ç”¨

##### 4.2 Selector

###### **åˆ›å»ºSelector** 

```Java
Selector selector = Selector.open();
```

###### **Selector æ³¨å†Œ** 

> accept - ä¼šåœ¨æœ‰è¿æ¥è¯·æ±‚æ—¶è§¦å‘
>
> connect - æ˜¯å®¢æˆ·ç«¯ï¼Œè¿æ¥è¯·æ±‚å»ºç«‹åè§¦å‘
>
> read - å¯è¯»äº‹ä»¶
>
> write - å¯å†™äº‹ä»¶

```Java
        //2. å»ºç«‹ selector å’Œ channel çš„è”ç³» ï¼ˆæ³¨å†Œï¼‰
        //SelectionKey å°±æ˜¯å°†æ¥äº‹ä»¶å‘ç”Ÿåï¼Œé€šè¿‡å®ƒçŸ¥é“äº‹ä»¶å’Œå“ªä¸ªchannelçš„äº‹ä»¶
        SelectionKey sscKey = ssc.register(selector, 0, null);
        sscKey.interestOps(SelectionKey.OP_ACCEPT);//keyåªå…³æ³¨ accept äº‹ä»¶
```
###### **é˜»å¡**

```Java
//3. select æ–¹æ³•ï¼Œæ²¡æœ‰äº‹ä»¶å‘ç”Ÿï¼Œçº¿ç¨‹å°±é˜»å¡ï¼Œæœ‰äº‹ä»¶å‘é€æ‰ä¼šæ¢å¤è¿è¡Œ
            selector.select();
//selector.selector(long timeout)å¸¦è¶…æ—¶çš„ã€Nettyä¸­ç”¨è¿™ä¸€ç§ã€‘
//selector.selectNow() éé˜»å¡
/*ä»¥ä¸Š3ç§æ–¹æ³•éƒ½æœ‰è¿”å›å€¼int è¡¨ç¤ºæœ‰å¤šå°‘channelå‘ç”Ÿäº†äº‹ä»¶*/
```

###### ğŸ’¡**selectä½•æ—¶ä¸é˜»å¡**

> * äº‹ä»¶å‘ç”Ÿæ—¶
>   * å®¢æˆ·ç«¯å‘é€è¿æ¥è¯·æ±‚ï¼Œä¼šè§¦å‘ accept äº‹ä»¶
>   * å®¢æˆ·ç«¯å‘é€æ•°æ®è¿‡æ¥ï¼Œå®¢æˆ·ç«¯æ­£å¸¸ã€å¼‚å¸¸å…³é—­æ—¶ï¼Œä¼šè§¦å‘ read äº‹ä»¶ï¼Œå¦å¤–å¦‚æœå‘é€çš„æ•°æ®å¤§äºbuffer ç¼“å†²åŒºï¼Œä¼šè§¦å‘ å¤šæ¬¡è¯»å–äº‹ä»¶
>   * channelå¯å†™ï¼Œä¼šè§¦å‘ write äº‹ä»¶
>   * åœ¨linuxä¸‹ NIO bug å‘ç”Ÿæ—¶ã€‹ã€‹[å…·ä½“å¯ä»¥çœ‹è¿™é‡Œ](https://blog.csdn.net/qq_45076180/article/details/113242674#%20netty%E5%A6%82%E4%BD%95%E8%A7%A3%E5%86%B3NIO%E7%A9%BA%E8%BD%AE%E8%AF%A2bug%E7%9A%84%EF%BC%9F)ã€Šã€Š
> * è°ƒç”¨ selector.wakeup()
> * è°ƒç”¨ selector.close()
> * selector æ‰€åœ¨çš„çº¿ç¨‹ Interrupt (æ‰“æ–­)

##### 4.3 å¤„ç†äº‹ä»¶

```Java
            for (SelectionKey key : selector.selectedKeys()) {
                ServerSocketChannel channel = (ServerSocketChannel) key.channel();
                SocketChannel socketChannel = channel.accept();
                //è¦ä¹ˆå¤„ç†è¦ä¹ˆå–æ¶ˆï¼Œå¦åˆ™ä¼šä¸€ç›´é™·å…¥éé˜»å¡çŠ¶æ€
                // å–æ¶ˆ channel.cancel()
            }
```

æœåŠ¡å™¨ç«¯**ä»£ç å®ä¾‹**

```Java
package F20240703;

import java.io.IOException;
import java.net.InetSocketAddress;
import java.nio.ByteBuffer;
import java.nio.channels.SelectionKey;
import java.nio.channels.Selector;
import java.nio.channels.ServerSocketChannel;
import java.nio.channels.SocketChannel;
import java.util.Iterator;


public class Server {
    public static void main(String[] args) throws IOException {
        //1. åˆ›å»º selector ,ç®¡ç†å¤šä¸ª channel
        Selector selector = Selector.open();

        ByteBuffer buff = ByteBuffer.allocate(16);
        ServerSocketChannel ssc = ServerSocketChannel.open();
        ssc.bind(new InetSocketAddress(9000));
        ssc.configureBlocking(false);
        //2. å»ºç«‹ selector å’Œ channel çš„è”ç³» ï¼ˆæ³¨å†Œï¼‰
        //SelectionKey å°±æ˜¯å°†æ¥äº‹ä»¶å‘ç”Ÿåï¼Œé€šè¿‡å®ƒçŸ¥é“äº‹ä»¶å’Œå“ªä¸ªchannelçš„äº‹ä»¶
        SelectionKey sscKey = ssc.register(selector, SelectionKey.OP_ACCEPT);
//        sscKey.interestOps(SelectionKey.OP_ACCEPT);

        while (true) {
            System.out.println("Waiting for connections...");
            selector.select();
            System.out.println("waiting for selection keys...");
            Iterator<SelectionKey> iterator = selector.selectedKeys().iterator();
            System.out.println("selection keys selected");
            while (iterator.hasNext()) {
                SelectionKey Key = iterator.next();
                System.out.println(STR."selection key: \{Key}");
                iterator.remove();//æ€è€ƒï¼šä¸ºä»€ä¹ˆè¦ç§»é™¤
                try {
                    //åŒºåˆ†äº‹ä»¶
                    if(Key.isAcceptable()) {//å¦‚æœæ˜¯accept
                        System.out.println("Acceptable");
                        ServerSocketChannel serverSocketChannel = (ServerSocketChannel) Key.channel();
                        SocketChannel socketChannel = serverSocketChannel.accept();
                        socketChannel.configureBlocking(false);
                        SelectionKey scKey = socketChannel.register(selector, 0);
                        scKey.interestOps(SelectionKey.OP_READ);
                        System.out.println(STR."Connected to \{socketChannel.getRemoteAddress()}");
                    }
                    else if(Key.isReadable()) {
                        System.out.println("Reading key...");
                        SocketChannel socketChannel = (SocketChannel) Key.channel();
                        buff.clear();
                        int read = socketChannel.read(buff);//å¦‚æœæ˜¯æ­£å¸¸æ–­å¼€ï¼Œread()è¿”å›å€¼æ˜¯-1
                        if(read == -1) {
                            System.out.println("Client disconnected");
                            Key.cancel();
                        }
                        buff.flip();
                        System.out.println(read);
                    }
                } catch (IOException e) {
                    e.printStackTrace();
                    Key.cancel();//å®¢æˆ·ç«¯æ–­å¼€ ï¼Œ éœ€è¦å°† key å–æ¶ˆï¼ˆä»Selector çš„ keys é›†åˆä¸­çœŸæ­£åˆ é™¤ keyï¼‰
                }
            }
//            for(SelectionKey Key : selector.selectedKeys()) {
//                selector.selectedKeys().remove(Key);
//
//            }
        }
    }
}


```

å®¢æˆ·ç«¯**ä»£ç å®ä¾‹**

```java
package F20240703;

import java.io.IOException;
import java.net.InetSocketAddress;
import java.net.SocketAddress;
import java.nio.channels.SocketChannel;

public class Client {
    public static void main(String[] args) throws IOException {
        SocketChannel sc = SocketChannel.open();
        sc.connect(new InetSocketAddress("127.0.0.1", 9000));
        SocketAddress sa = sc.getRemoteAddress();
        System.out.println(STR."Connected to \{sc.socket().getRemoteSocketAddress()}");
        sc.close();

    }
}

```

###### **å¤„ç†æ¶ˆæ¯è¾¹ç•Œ**

æ€è·¯ï¼š

1. å®¢æˆ·ç«¯å›ºå®šBufferæ¶ˆæ¯é•¿åº¦  

   <font color="\#FFC0C">**ç¼ºç‚¹:**æ¶ˆæ¯é•¿åº¦ä¸ä¸€æ—¶ï¼Œä¼šæµªè´¹å¸¦å®½</font>

2. å®¢æˆ·ç«¯åœ¨æ¶ˆæ¯ä¸­æ·»åŠ åˆ†éš”ç¬¦,æœåŠ¡å™¨æŒ‰åˆ†éš”ç¬¦é‡æ–°ç»„ç»‡æ¶ˆæ¯ 

   <font color="#FFC0CB">**ç¼ºç‚¹:**æ•ˆç‡ä¸é«˜ï¼Œä¸”æ— æ³•è§£å†³é•¿æ¶ˆæ¯é—®é¢˜</font>

3. å°†æ¶ˆæ¯å˜æˆä¸¤éƒ¨åˆ†ï¼Œä¸€éƒ¨åˆ†å‘é€å†…å®¹çš„é•¿åº¦ï¼Œç¬¬äºŒéƒ¨åˆ†å‘é€å®é™…çš„å†…å®¹ï¼ˆè¾ƒå¸¸ç”¨ï¼‰ã€TLVæ ¼å¼ã€‘

   > **Tï¼šType ç±»å‹ï¼ŒLï¼šLength é•¿åº¦ï¼ŒVï¼šValue æ•°æ®**

   åœ¨ç±»å‹ä¸é•¿åº¦å·²çŸ¥çš„æƒ…å†µä¸‹å°±å¯ä»¥æ–¹ä¾¿çš„è·å–æ¶ˆæ¯å¤§å°ï¼Œåˆ†é…åˆé€‚çš„buffer

   <font color=\#FFC0C>**ç¼ºç‚¹:**bufferéœ€è¦æå‰åˆ†é…ï¼Œå¦‚æœå†…å®¹è¿‡å¤§ï¼Œåˆ™ä¼šå½±å“ Server ååé‡</font>

   * Http 1.1 æ˜¯TLV æ ¼å¼

   * Http 2.0 æ˜¯LTV æ ¼å¼

     å‡è®¾bufferå¤§å°ä¸º16

```mermaid
sequenceDiagram
	participant C1 as å®¢æˆ·ç«¯1
	participant s as æœåŠ¡å™¨
	participant b1 as ByteBuffer1
	participant b2 as ByteBuffer2
	C1 ->> s: å‘é€ 0123456789abcdef1001\r
    s ->> b1: ç¬¬ä¸€æ¬¡ read å­˜å…¥ 0123456789abcdef
    s ->> b2: æ‰©å®¹
    b1 ->> b2: æ‹·è´ 0123456789abcdef
    s ->> b2: ç¬¬äºŒæ¬¡ read å­˜å…¥ 1001\r
    b2 ->> b2: 0123456789abcdef1001\r
```

```java
package F20240703;

import java.io.IOException;
import java.net.InetSocketAddress;
import java.nio.ByteBuffer;
import java.nio.channels.SelectionKey;
import java.nio.channels.Selector;
import java.nio.channels.ServerSocketChannel;
import java.nio.channels.SocketChannel;
import java.nio.charset.Charset;
import java.nio.charset.StandardCharsets;
import java.util.Iterator;


public class Server {
    public static void main(String[] args) throws IOException {
        //1. åˆ›å»º selector ,ç®¡ç†å¤šä¸ª channel
        Selector selector = Selector.open();
        ServerSocketChannel ssc = ServerSocketChannel.open();
        ssc.bind(new InetSocketAddress(9000));
        ssc.configureBlocking(false);
        //2. å»ºç«‹ selector å’Œ channel çš„è”ç³» ï¼ˆæ³¨å†Œï¼‰
        //SelectionKey å°±æ˜¯å°†æ¥äº‹ä»¶å‘ç”Ÿåï¼Œé€šè¿‡å®ƒçŸ¥é“äº‹ä»¶å’Œå“ªä¸ªchannelçš„äº‹ä»¶
        SelectionKey sscKey = ssc.register(selector, SelectionKey.OP_ACCEPT);
//        sscKey.interestOps(SelectionKey.OP_ACCEPT);
//é™„ä»¶attachment
        while (true) {
            System.out.println("Waiting for connections...");
            selector.select();
            System.out.println("waiting for selection keys...");
            Iterator<SelectionKey> iterator = selector.selectedKeys().iterator();
            System.out.println("selection keys selected");
            while (iterator.hasNext()) {
                SelectionKey Key = iterator.next();
                System.out.println(STR."selection key: \{Key}");
                iterator.remove();
                try {
                    //åŒºåˆ†äº‹ä»¶
                    if(Key.isAcceptable()) {//å¦‚æœæ˜¯accept
                        System.out.println("Acceptable");
                        ServerSocketChannel serverSocketChannel = (ServerSocketChannel) Key.channel();
                        SocketChannel socketChannel = serverSocketChannel.accept();
                        socketChannel.configureBlocking(false);
                        ByteBuffer buff = ByteBuffer.allocate(16);
                        SelectionKey scKey = socketChannel.register(selector, 0, buff);//å°†ä¸€ä¸ªBufferä½œä¸ºä¸€ä¸ªé™„ä»¶å…³è”åˆ°ä¸€ä¸ªé™„ä»¶ä¸Š
                        scKey.interestOps(SelectionKey.OP_READ);
                        System.out.println(STR."Connected to \{socketChannel.getRemoteAddress()}");
                    }
                    else if(Key.isReadable()) {
                        System.out.println("Reading key...");
                        SocketChannel socketChannel = (SocketChannel) Key.channel();
                        ByteBuffer buff = (ByteBuffer) Key.attachment();//è·å–é™„ä»¶attachment()
                        int read = socketChannel.read(buff);//å¦‚æœæ˜¯æ­£å¸¸æ–­å¼€ï¼Œread()è¿”å›å€¼æ˜¯-1
                        if(read == -1) {
                            System.out.println("Client disconnected");
                            Key.cancel();
                        } else {
                            spilt(buff);
                            if(buff.position() == buff.limit()) {
                                System.out.println("Created new ByteBuffer");
                                ByteBuffer newBuff = ByteBuffer.allocate(buff.capacity() * 2);
                                buff.flip();
                                newBuff.put(buff);
                                Key.attach(newBuff);//æ›¿æ¢
                            } else {
                                buff.flip();
                                System.out.println(STR."read: \{read}");
                                System.out.println(StandardCharsets.UTF_8.decode(buff));
                            }
                        }

                    }
                } catch (IOException e) {
                    e.printStackTrace();
                    Key.cancel();//å®¢æˆ·ç«¯æ–­å¼€ ï¼Œ éœ€è¦å°† key å–æ¶ˆï¼ˆä»Selector çš„ keys é›†åˆä¸­çœŸæ­£åˆ é™¤ keyï¼‰
                }
            }
//            for(SelectionKey Key : selector.selectedKeys()) {
//                selector.selectedKeys().remove(Key);
//
//            }
        }
    }
    private static void spilt(ByteBuffer source) {
        source.flip();
        for(int i = 0; i < source.limit(); i++) {
            if(source.get(i) == '\n') {
                //æ‰¾åˆ°ä¸€ä¸ªå®Œæ•´çš„æ¶ˆæ¯
                int length = i + 1 - source.position();
                ByteBuffer target = ByteBuffer.allocate(length);

                for(int j = 0; j < length; j++) {
                    target.put(source.get());
                }
            }
        }
        source.compact();//0123456789abcdef position:16 limit:16(å¦‚æœæ²¡æœ‰æ‰¾åˆ°åˆ†éš”ç¬¦ï¼Œè¯´æ˜buffä¸å¤Ÿ)
    }
}

```



###### **ByteBufferå¤§å°åˆ†é…**

* æ¯ä¸ª channel éƒ½éœ€è¦è®°å½•å¯èƒ½è¢«åˆ‡åˆ†çš„æ¶ˆæ¯ï¼Œå› ä¸º ByteBuffer ä¸èƒ½è¢«å¤šä¸ª channel å…±åŒä½¿ç”¨ï¼Œå› æ­¤éœ€è¦ä¸ºæ¯ä¸€ä¸ª channel ç»´æŠ¤ä¸€ä¸ªç‹¬ç«‹çš„ByteBuffer
* ByteBuffer ä¸èƒ½å¤ªå¤§ï¼Œä¾‹å¦‚ä¸€ä¸ª ByteBuffer 1Mb çš„è¯ï¼Œè¦æ”¯æŒç™¾ä¸‡è¿æ¥å°±éœ€è¦ 1TB çš„å†…å­˜ï¼Œå› æ­¤è¦è®¾è®¡å¯å˜çš„ ByteBuffer
  * ä¸€ç§æ€è·¯æ˜¯é¦–å…ˆåˆ†é…ä¸€ä¸ªè¾ƒå°çš„ buffer ï¼Œä¾‹å¦‚ 4Kï¼Œå¦‚æœå‘ç°Â·æ•°æ®ä¸å¤Ÿï¼Œå†åˆ†é… 8K çš„ buffer ï¼Œå°† 4K bufferçš„å†…å®¹æ‹·è´åˆ° 8K bufferï¼Œä¼˜ç‚¹æ˜¯æ¶ˆæ¯çš„è¿ç»­å®¹æ˜“å¤„ç†ï¼Œç¼ºç‚¹æ˜¯æ•°æ®æ‹·è´è€—è´¹æ€§èƒ½
  * å¦ä¸€ç§æ€è·¯æ˜¯ç”¨å¤šä¸ªæ•°ç»„ç»„æˆçš„ buffer ï¼Œä¸€ä¸ªæ•°ç»„ä¸å¤Ÿï¼ŒæŠŠå¤šå‡ºæ¥çš„å†…å®¹å†™å…¥åˆ°æ–°çš„æ•°ç»„ï¼Œä¸å‰é¢çš„åŒºåˆ«æ˜¯æ¶ˆæ¯å­˜å‚¨ä¸è¿ç»­è§£æè´Ÿè´£ï¼Œä¼˜ç‚¹æ˜¯é¿å…å“¦äº†æ‹·è´å¼•å‘çš„æ€§èƒ½æ¶ˆè€—

##### 4.4 å†™å…¥ã€æœåŠ¡å™¨å‘å®¢æˆ·ç«¯å†™å…¥æ•°æ®ã€‘

```Java
package F20240703;

import java.io.IOException;
import java.net.InetSocketAddress;
import java.nio.ByteBuffer;
import java.nio.channels.SelectionKey;
import java.nio.channels.Selector;
import java.nio.channels.ServerSocketChannel;
import java.nio.channels.SocketChannel;
import java.nio.charset.Charset;
import java.util.Iterator;

public class WriteServer {
    public static void main(String[] args) throws IOException {
        ServerSocketChannel ssc = ServerSocketChannel.open();
        ssc.configureBlocking(false);

        Selector selector = Selector.open();
        ssc.register(selector, SelectionKey.OP_ACCEPT);

        ssc.socket().bind(new InetSocketAddress(9000));
        while (true) {
            selector.select();
            Iterator<SelectionKey> iterator = selector.selectedKeys().iterator();
            while (iterator.hasNext()) {
                SelectionKey key = iterator.next();
                iterator.remove();
                if(key.isAcceptable()) {
                    SocketChannel sc = ssc.accept();
                    sc.configureBlocking(false);
                    //1.å‘å®¢æˆ·ç«¯å‘é€å¤§é‡æ•°æ®
                    StringBuilder sb = new StringBuilder();
                    for (int i = 0; i < 300000000; i++) {
                        sb.append('a');
                    }
                    ByteBuffer buffer = Charset.defaultCharset().encode(sb.toString());
					// ä¸èƒ½ä¸€æ¬¡æ€§å‘é€å®Œï¼Œä¸”å‘é€åŒºç¼“å­˜å·²æ»¡æ—¶æ— æ³•å‘é€æ•°æ®ï¼Œæ­¤æ—¶çº¿ç¨‹è¢«å ç”¨æ¥ä¸€ç›´å‘é€æ•°æ®ã€é—®é¢˜ã€‘
                    while(buffer.hasRemaining()) {
                        int written = sc.write(buffer);
                        System.out.println(STR."å†™å…¥å­—èŠ‚æ•°\{written}");
                    }
                }
            }
        }
    }
}

```

ç”¨ **äº‹ä»¶æ¥æ”¹è¿›å¾ªç¯** ç‰ˆ

```Java
package F20240703;

import java.io.IOException;
import java.net.InetSocketAddress;
import java.nio.ByteBuffer;
import java.nio.channels.SelectionKey;
import java.nio.channels.Selector;
import java.nio.channels.ServerSocketChannel;
import java.nio.channels.SocketChannel;
import java.nio.charset.Charset;
import java.util.Iterator;

public class WriteServer {
    public static void main(String[] args) throws IOException {
        ServerSocketChannel ssc = ServerSocketChannel.open();
        ssc.configureBlocking(false);

        Selector selector = Selector.open();
        ssc.register(selector, SelectionKey.OP_ACCEPT);

        ssc.socket().bind(new InetSocketAddress(9000));
        while (true) {
            selector.select();
            Iterator<SelectionKey> iterator = selector.selectedKeys().iterator();
            while (iterator.hasNext()) {
                SelectionKey key = iterator.next();
                iterator.remove();
                if(key.isAcceptable()) {
                    SocketChannel sc = ssc.accept();
                    sc.configureBlocking(false);
                    //1.å‘å®¢æˆ·ç«¯å‘é€æ•°æ®
                    StringBuilder sb = new StringBuilder();
                    for (int i = 0; i < 300000000; i++) {
                        sb.append('a');
                    }
                    ByteBuffer buffer = Charset.defaultCharset().encode(sb.toString());

                    //2.è¿”å›å€¼ä»£è¡¨å®é™…å†™å…¥çš„å­—èŠ‚æ•°
                    int write = sc.write(buffer);
                    System.out.println(write);

                    //3.åˆ¤æ–­ååˆ†æœ‰å‰©ä½™å†…å®¹
                    if(buffer.hasRemaining()) {

                        //4. å…³æ³¨è¿æ¥+å¯å†™äº‹ä»¶ 1 + 4 = 5 & ä½¿ç”¨ä½è¿ç®—ç¬¦"|"
                        key.interestOps( key.interestOps() + SelectionKey.OP_WRITE);

                        //5.æŠŠæœªå†™å®Œçš„æ•°æ®æŒ‚åˆ°Key ä¸Š
                        key.attach(buffer);
                    }
                }
                else if(key.isWritable()) {
                    ByteBuffer buffer = (ByteBuffer) key.attachment();
                    SocketChannel sc = (SocketChannel) key.channel();
                    int write = sc.write(buffer);
                    System.out.println(write);
                    //6ï¼Œæ¸…ç†å·¥ä½œï¼ˆBufferæ•°æ®å¾ˆå¤šï¼‰ã€å–æ¶ˆå…³æ³¨å¯å†™äº‹ä»¶ã€‘
                    if(!buffer.hasRemaining()) {
                        key.attach(null);
                        key.interestOps(key.interestOps() - SelectionKey.OP_WRITE);
                    }
                }
            }
        }
    }
}

```



##### 4.5 è¿›ä¸€æ­¥ä¼˜åŒ–

ğŸ’¡**åˆ©ç”¨å¤šçº¿ç¨‹ä¼˜åŒ–**

â€‹	äº†è§£Redisåˆšå¼€å§‹è®¾è®¡æ—¶çš„ç¼ºé™·

> ç°åœ¨éƒ½æ˜¯å¤šæ ¸Cpuï¼Œè®¾è®¡æ—¶éœ€å……åˆ†è€ƒè™‘å……åˆ†ä½¿ç”¨Cpuçš„æ€§èƒ½

å‰é¢çš„ä»£ç å®ä¾‹åªæœ‰ä¸€ä¸ªé€‰æ‹©å™¨ï¼Œæ²¡æœ‰å……åˆ†åˆ©ç”¨å¤šæ ¸cpu

* å¦‚æœåœ¨æŸä¸ªäº‹ä»¶è€—æ—¶è¾ƒé•¿ï¼ŒåŠ¿å¿…ä¼šå½±å“å…¶å®ƒäº‹ä»¶å¤„ç†

å¦‚ä½•æ”¹è¿›ï¼Ÿ

åˆ†ä¸¤ç»„é€‰æ‹©å™¨

* å•çº¿ç¨‹é…ä¸€ä¸ªé€‰æ‹©å™¨ï¼Œä¸“é—¨å¤„ç† accept äº‹ä»¶
* åˆ›å»º cpu æ ¸å¿ƒæ•°çš„çº¿ç¨‹ï¼Œæ¯ä¸€ä¸ªçº¿ç¨‹é…ä¸€ä¸ªé€‰æ‹©å™¨ï¼Œè½®æµå¤„ç† read äº‹ä»¶

**å•workerç‰ˆå®ä¾‹**

```Java
package F20240703;

import java.io.IOException;
import java.net.InetSocketAddress;
import java.nio.ByteBuffer;
import java.nio.channels.*;
import java.nio.charset.StandardCharsets;
import java.util.Iterator;
import java.util.concurrent.ConcurrentLinkedQueue;

public class MultiThreadServer {
    public static void main(String[] args) throws IOException {
        Thread.currentThread().setName("IBoss");
        ServerSocketChannel ssc = ServerSocketChannel.open();
        ssc.configureBlocking(false);
        Selector boss = Selector.open();
        SelectionKey bossKey = ssc.register(boss, 0, null);
        bossKey.interestOps(SelectionKey.OP_ACCEPT);
        ssc.bind(new InetSocketAddress(9000));
        //1.åˆ›å»ºå›ºå®šæ•°é‡çš„worker
        Worker worker = new Worker("worker-0");

        while (true) {
            boss.select();
            Iterator<SelectionKey> iterator = boss.selectedKeys().iterator();
            while (iterator.hasNext()) {
                SelectionKey key = iterator.next();
                iterator.remove();
                if(key.isAcceptable()) {
                    SocketChannel sc = ssc.accept();
                    sc.configureBlocking(false);
                    //2. å…³è”selector å¯ç›´æ¥è®¿é—®é™æ€å†…éƒ¨ç±»çš„ç§æœ‰æˆå‘˜å˜é‡
                    System.out.println(STR."before register...\{sc.getRemoteAddress()}");
                    worker.register(sc);
//                    sc.register(worker.workerSelector, SelectionKey.OP_READ, null);//å¯è¯»äº‹ä»¶
                    System.out.println(STR."after register...\{sc.getRemoteAddress()}");
                }
            }
        }
    }
    static class Worker implements Runnable {
        private Thread thread;
        private Selector workerSelector;
        private String name;
        private volatile boolean started = false; //è¿˜æœªåˆå§‹åŒ–
        private ConcurrentLinkedQueue<Runnable> queue = new ConcurrentLinkedQueue<>();//çº¿ç¨‹å®‰å…¨ä»»åŠ¡é˜Ÿåˆ—
        public Worker(String name){
            this.name = name;
        }
        public void register(SocketChannel socketChannel) throws IOException {
            if(!started) {
                thread = new Thread(this, name);
                workerSelector = Selector.open();
                thread.start();
                started = true;
            }
            //åœ¨Bossçº¿ç¨‹é‡Œå‘é˜Ÿåˆ—æ·»åŠ ä»»åŠ¡,ä½†è¿™ä¸ªä»»åŠ¡æ²¡æœ‰ç«‹åˆ»æ‰§è¡Œ
            queue.add(()->{
                try {
                    socketChannel.register(workerSelector, SelectionKey.OP_READ, null);//å¯è¯»äº‹ä»¶
                } catch (ClosedChannelException e) {
                    e.printStackTrace();
                }
            });
            workerSelector.wakeup();

        }

        @Override
        public void run() {
            while(true) {
                try {
                    workerSelector.select(); //worker-0 é˜»å¡ wakeup
                    Runnable task = queue.poll();
                    if(task != null) {
                        task.run();//åœ¨worker-0æ‰§è¡Œäº† æ³¨å†Œ
                    }
                    Iterator<SelectionKey> iterator = workerSelector.selectedKeys().iterator();
                    while (iterator.hasNext()) {
                        SelectionKey key = iterator.next();
                        iterator.remove();
                        if (key.isReadable()) {
                            ByteBuffer buffer = ByteBuffer.allocate(16);
                            SocketChannel sc = (SocketChannel) key.channel();
                            int size = sc.read(buffer);
                            if(size == -1) {
                                System.out.println("Client disconnected");
                                key.cancel();
                            }
                            buffer.flip();
                            System.out.println(STR."Read :\{StandardCharsets.UTF_8.decode(buffer)}");
                        }
                    }
                } catch (IOException e) {
                    e.printStackTrace();
                }
            }
        }
    }
}

```

åˆ›å»ºå¤šä¸ªWorker

```java
package F20240703;

import java.io.IOException;
import java.net.InetSocketAddress;
import java.nio.ByteBuffer;
import java.nio.channels.*;
import java.nio.charset.StandardCharsets;
import java.util.Iterator;
import java.util.concurrent.ConcurrentLinkedQueue;
import java.util.concurrent.atomic.AtomicInteger;

public class MultiThreadServer {
    public static void main(String[] args) throws IOException {
        Thread.currentThread().setName("IBoss");
        ServerSocketChannel ssc = ServerSocketChannel.open();
        ssc.configureBlocking(false);
        Selector boss = Selector.open();
        SelectionKey bossKey = ssc.register(boss, 0, null);
        bossKey.interestOps(SelectionKey.OP_ACCEPT);
        ssc.bind(new InetSocketAddress(9000));
        //1.åˆ›å»ºå›ºå®šæ•°é‡çš„worker
        // Runtime.getRuntime().availableProcessors()
        Worker[] workers = new Worker[Runtime.getRuntime().availableProcessors()];
        for(int i = 0; i < workers.length; i++) {
            workers[i] = new Worker(STR."worker-\{i}");
        }
        AtomicInteger index = new AtomicInteger(0);
//        Worker worker = new Worker("worker-0");

        while (true) {
            boss.select();
            Iterator<SelectionKey> iterator = boss.selectedKeys().iterator();
            while (iterator.hasNext()) {
                SelectionKey key = iterator.next();
                iterator.remove();
                if(key.isAcceptable()) {
                    SocketChannel sc = ssc.accept();
                    sc.configureBlocking(false);
                    //2. å…³è”selector å¯ç›´æ¥è®¿é—®é™æ€å†…éƒ¨ç±»çš„ç§æœ‰æˆå‘˜å˜é‡
                    System.out.println(STR."before register...\{sc.getRemoteAddress()}");
                    //round robinè½®è¯¢ç®—æ³•
                    workers[index.getAndIncrement() % workers.length].register(sc);
//                    worker.register(sc);
//                    sc.register(worker.workerSelector, SelectionKey.OP_READ, null);//å¯è¯»äº‹ä»¶
                    System.out.println(STR."after register...\{sc.getRemoteAddress()}");
                }
            }
        }
    }
    static class Worker implements Runnable {
        private Thread thread;
        private Selector workerSelector;
        private String name;
        private volatile boolean started = false; //è¿˜æœªåˆå§‹åŒ–
        private ConcurrentLinkedQueue<Runnable> queue = new ConcurrentLinkedQueue<>();//çº¿ç¨‹å®‰å…¨ä»»åŠ¡é˜Ÿåˆ—
        public Worker(String name){
            this.name = name;
        }
        public void register(SocketChannel socketChannel) throws IOException {
            if(!started) {
                thread = new Thread(this, name);
                workerSelector = Selector.open();
                thread.start();
                started = true;
            }
            //åœ¨Bossçº¿ç¨‹é‡Œå‘é˜Ÿåˆ—æ·»åŠ ä»»åŠ¡,ä½†è¿™ä¸ªä»»åŠ¡æ²¡æœ‰ç«‹åˆ»æ‰§è¡Œ
            queue.add(()->{
                try {
                    socketChannel.register(workerSelector, SelectionKey.OP_READ, null);//å¯è¯»äº‹ä»¶
                } catch (ClosedChannelException e) {
                    e.printStackTrace();
                }
            });
            workerSelector.wakeup();

        }

        @Override
        public void run() {
            while(true) {
                try {
                    workerSelector.select(); //worker-0 é˜»å¡ wakeup
                    Runnable task = queue.poll();
                    if(task != null) {
                        task.run();//åœ¨worker-0æ‰§è¡Œäº† æ³¨å†Œ
                    }
                    Iterator<SelectionKey> iterator = workerSelector.selectedKeys().iterator();
                    while (iterator.hasNext()) {
                        SelectionKey key = iterator.next();
                        iterator.remove();
                        if (key.isReadable()) {
                            ByteBuffer buffer = ByteBuffer.allocate(16);
                            SocketChannel sc = (SocketChannel) key.channel();
                            int size = sc.read(buffer);
                            if(size == -1) {
                                System.out.println("Client disconnected");
                                key.cancel();
                            }
                            buffer.flip();
                            System.out.println(STR."Read :\{StandardCharsets.UTF_8.decode(buffer)}");
                        }
                    }
                } catch (IOException e) {
                    e.printStackTrace();
                }
            }
        }
    }
}

```

ğŸ’¡å¦‚ä½•æ‹¿åˆ°cpuä¸ªæ•°

> *  Runtime.getRuntime().availableProcessors() å¦‚æœå·¥ä½œåœ¨ docker å®¹å™¨ä¸‹ï¼Œå› ä¸ºå®¹å™¨ä¸æ˜¯ç‰©ç†éš”ç¦»çš„ï¼Œä¼šæ‹¿åˆ°ç‰©ç†cpuçš„ä¸ªæ•°ï¼Œè€Œä¸æ˜¯å®¹å™¨ç”³è¯·æ—¶çš„ä¸ªæ•°
> * ä¸Šè¿°é—®é¢˜ç›´åˆ° jdk 10 æ‰ä¿®å¤ ï¼Œä½¿ç”¨ jvm å‚æ•°Â· UseContainSupport é…ç½® ï¼Œé»˜è®¤å¼€å¯

#### 5. NIO vs BIO

##### 5.1 stream vs channel

* stream ä¸ä¼šè‡ªåŠ¨ç¼“å†²æ•°æ®ï¼Œchannel ä¼šåˆ©ç”¨ç³»ç»Ÿæä¾›çš„å‘é€ç¼“å†²åŒºã€æ¥æ”¶ç¼“å†²åŒºï¼ˆæ›´ä¸ºåº•å±‚ï¼‰
* stream ä»…æ”¯æŒé˜»å¡ APIï¼Œchannel åŒæ—¶æ”¯æŒé˜»å¡ã€éé˜»å¡ APIï¼Œç½‘ç»œ channel å¯é…åˆ selector å®ç°å¤šè·¯å¤ç”¨
* äºŒè€…å‡ä¸º**å…¨åŒå·¥**ï¼Œå³è¯»å†™å¯ä»¥åŒæ—¶è¿›è¡Œ

##### 5.2 IO æ¨¡å‹

åŒæ­¥é˜»å¡ã€åŒæ­¥éé˜»å¡ã€å¤šè·¯å¤ç”¨ã€~~å¼‚æ­¥é˜»å¡~~ï¼ˆæ²¡æœ‰è¯¥æƒ…å†µï¼‰ã€å¼‚æ­¥éé˜»å¡

* åŒæ­¥ï¼šçº¿ç¨‹è‡ªå·±å»è·å–ç»“æœï¼ˆä¸€ä¸ªçº¿ç¨‹ï¼‰
* å¼‚æ­¥ï¼šçº¿ç¨‹è‡ªå·±ä¸å»è·å–ç»“æœï¼Œè€Œæ˜¯ç”±å…¶å®ƒçº¿ç¨‹é€ç»“æœï¼ˆè‡³å°‘ä¸¤ä¸ªçº¿ç¨‹ï¼‰

å½“è°ƒç”¨ä¸€æ¬¡ channel.read æˆ– stream.read åï¼Œä¼šåˆ‡æ¢è‡³**æ“ä½œç³»ç»Ÿå†…æ ¸æ€**æ¥å®ŒæˆçœŸæ­£æ•°æ®è¯»å–ï¼Œè€Œè¯»å–åˆåˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µï¼Œåˆ†åˆ«ä¸ºï¼š

* ç­‰å¾…æ•°æ®é˜¶æ®µ
* å¤åˆ¶æ•°æ®é˜¶æ®µ

IOæ¨¡å‹

* é˜»å¡IO
* éé˜»å¡IO
* å¤šè·¯å¤ç”¨
* ä¿¡å·é©±åŠ¨

UNIXç½‘ç»œç¼–ç¨‹ - å·1

##### 5.3 é›¶æ‹·è´

**ä¼ ç»Ÿ IO é—®é¢˜**

ä¼ ç»Ÿçš„ IO å°†ä¸€ä¸ªæ–‡ä»¶é€šè¿‡ socket å†™å‡º

```java
File f = new File("helloword/data.txt");
RandomAccessFile file = new RandomAccessFile(file, "r");

byte[] buf = new byte[(int)f.length()];
file.read(buf);

Socket socket = ...;
socket.getOutputStream().write(buf);
```

å†…éƒ¨å·¥ä½œæµç¨‹æ˜¯è¿™æ ·çš„ï¼š

1. java æœ¬èº«å¹¶ä¸å…·å¤‡ IO è¯»å†™èƒ½åŠ›ï¼Œå› æ­¤ read æ–¹æ³•è°ƒç”¨åï¼Œè¦ä» java ç¨‹åºçš„**ç”¨æˆ·æ€**åˆ‡æ¢è‡³**å†…æ ¸æ€**ï¼Œå»è°ƒç”¨æ“ä½œç³»ç»Ÿï¼ˆKernelï¼‰çš„è¯»èƒ½åŠ›ï¼Œå°†æ•°æ®è¯»å…¥**å†…æ ¸ç¼“å†²åŒº**ã€‚è¿™æœŸé—´ç”¨æˆ·çº¿ç¨‹é˜»å¡ï¼Œæ“ä½œç³»ç»Ÿä½¿ç”¨ DMAï¼ˆDirect Memory Accessï¼‰æ¥å®ç°æ–‡ä»¶è¯»ï¼Œå…¶é—´ä¹Ÿä¸ä¼šä½¿ç”¨ cpu

   > DMA ä¹Ÿå¯ä»¥ç†è§£ä¸ºç¡¬ä»¶å•å…ƒï¼Œç”¨æ¥è§£æ”¾ cpu å®Œæˆæ–‡ä»¶ IO

2. ä»**å†…æ ¸æ€**åˆ‡æ¢å›**ç”¨æˆ·æ€**ï¼Œå°†æ•°æ®ä»**å†…æ ¸ç¼“å†²åŒº**è¯»å…¥**ç”¨æˆ·ç¼“å†²åŒº**ï¼ˆå³ byte[] bufï¼‰ï¼Œè¿™æœŸé—´ cpu ä¼šå‚ä¸æ‹·è´ï¼Œæ— æ³•åˆ©ç”¨ DMA

3. è°ƒç”¨ write æ–¹æ³•ï¼Œè¿™æ—¶å°†æ•°æ®ä»**ç”¨æˆ·ç¼“å†²åŒº**ï¼ˆbyte[] bufï¼‰å†™å…¥ **socket ç¼“å†²åŒº**ï¼Œcpu ä¼šå‚ä¸æ‹·è´

4. æ¥ä¸‹æ¥è¦å‘ç½‘å¡å†™æ•°æ®ï¼Œè¿™é¡¹èƒ½åŠ› java åˆä¸å…·å¤‡ï¼Œå› æ­¤åˆå¾—ä»**ç”¨æˆ·æ€**åˆ‡æ¢è‡³**å†…æ ¸æ€**ï¼Œè°ƒç”¨æ“ä½œç³»ç»Ÿçš„å†™èƒ½åŠ›ï¼Œä½¿ç”¨ DMA å°† **socket ç¼“å†²åŒº**çš„æ•°æ®å†™å…¥ç½‘å¡ï¼Œä¸ä¼šä½¿ç”¨ cpu



å¯ä»¥çœ‹åˆ°ä¸­é—´ç¯èŠ‚è¾ƒå¤šï¼Œjava çš„ IO å®é™…ä¸æ˜¯ç‰©ç†è®¾å¤‡çº§åˆ«çš„è¯»å†™ï¼Œè€Œæ˜¯ç¼“å­˜çš„å¤åˆ¶ï¼Œåº•å±‚çš„çœŸæ­£è¯»å†™æ˜¯æ“ä½œç³»ç»Ÿæ¥å®Œæˆçš„

* ç”¨æˆ·æ€ä¸å†…æ ¸æ€çš„åˆ‡æ¢å‘ç”Ÿäº† 3 æ¬¡ï¼Œè¿™ä¸ªæ“ä½œæ¯”è¾ƒé‡é‡çº§
* æ•°æ®æ‹·è´äº†å…± 4 æ¬¡

**NIOä¼˜åŒ–**

é€šè¿‡DirectByteBuf

* ByteBuffer.allocate(10)  HeapByteBuffer ä½¿ç”¨çš„è¿˜æ˜¯ java å†…å­˜
* ByteBuffer.allocateDirect(10)  DirectByteBuffer ä½¿ç”¨çš„æ˜¯æ“ä½œç³»ç»Ÿå†…å­˜

å¤§éƒ¨åˆ†æ­¥éª¤ä¸ä¼˜åŒ–å‰ç›¸åŒï¼Œä¸å†èµ˜è¿°ã€‚å”¯æœ‰ä¸€ç‚¹ï¼šjava å¯ä»¥ä½¿ç”¨ DirectByteBuf å°†å †å¤–å†…å­˜æ˜ å°„åˆ° jvm å†…å­˜ä¸­æ¥ç›´æ¥è®¿é—®ä½¿ç”¨

* è¿™å—å†…å­˜ä¸å— jvm åƒåœ¾å›æ”¶çš„å½±å“ï¼Œå› æ­¤å†…å­˜åœ°å€å›ºå®šï¼Œæœ‰åŠ©äº IO è¯»å†™
* java ä¸­çš„ DirectByteBuf å¯¹è±¡ä»…ç»´æŠ¤äº†æ­¤å†…å­˜çš„è™šå¼•ç”¨ï¼Œå†…å­˜å›æ”¶åˆ†æˆä¸¤æ­¥
  * DirectByteBuf å¯¹è±¡è¢«åƒåœ¾å›æ”¶ï¼Œå°†è™šå¼•ç”¨åŠ å…¥å¼•ç”¨é˜Ÿåˆ—
  * é€šè¿‡ä¸“é—¨çº¿ç¨‹è®¿é—®å¼•ç”¨é˜Ÿåˆ—ï¼Œæ ¹æ®è™šå¼•ç”¨é‡Šæ”¾å †å¤–å†…å­˜
* å‡å°‘äº†ä¸€æ¬¡æ•°æ®æ‹·è´ï¼Œç”¨æˆ·æ€ä¸å†…æ ¸æ€çš„åˆ‡æ¢æ¬¡æ•°æ²¡æœ‰å‡å°‘

è¿›ä¸€æ­¥ä¼˜åŒ–ï¼ˆåº•å±‚é‡‡ç”¨äº† linux 2.1 åæä¾›çš„ sendFile æ–¹æ³•ï¼‰ï¼Œjava ä¸­å¯¹åº”ç€ä¸¤ä¸ª channel è°ƒç”¨ transferTo/transferFrom æ–¹æ³•æ‹·è´æ•°æ®

1. java è°ƒç”¨ transferTo æ–¹æ³•åï¼Œè¦ä» java ç¨‹åºçš„**ç”¨æˆ·æ€**åˆ‡æ¢è‡³**å†…æ ¸æ€**ï¼Œä½¿ç”¨ DMAå°†æ•°æ®è¯»å…¥**å†…æ ¸ç¼“å†²åŒº**ï¼Œä¸ä¼šä½¿ç”¨ cpu
2. æ•°æ®ä»**å†…æ ¸ç¼“å†²åŒº**ä¼ è¾“åˆ° **socket ç¼“å†²åŒº**ï¼Œcpu ä¼šå‚ä¸æ‹·è´
3. æœ€åä½¿ç”¨ DMA å°† **socket ç¼“å†²åŒº**çš„æ•°æ®å†™å…¥ç½‘å¡ï¼Œä¸ä¼šä½¿ç”¨ cpu

å¯ä»¥çœ‹åˆ°

* åªå‘ç”Ÿäº†ä¸€æ¬¡ç”¨æˆ·æ€ä¸å†…æ ¸æ€çš„åˆ‡æ¢
* æ•°æ®æ‹·è´äº† 3 æ¬¡

è¿›ä¸€æ­¥ä¼˜åŒ–ï¼ˆlinux 2.4ï¼‰

1. java è°ƒç”¨ transferTo æ–¹æ³•åï¼Œè¦ä» java ç¨‹åºçš„**ç”¨æˆ·æ€**åˆ‡æ¢è‡³**å†…æ ¸æ€**ï¼Œä½¿ç”¨ DMAå°†æ•°æ®è¯»å…¥**å†…æ ¸ç¼“å†²åŒº**ï¼Œä¸ä¼šä½¿ç”¨ cpu
2. åªä¼šå°†ä¸€äº› offset å’Œ length ä¿¡æ¯æ‹·å…¥ **socket ç¼“å†²åŒº**ï¼Œå‡ ä¹æ— æ¶ˆè€—
3. ä½¿ç”¨ DMA å°† **å†…æ ¸ç¼“å†²åŒº**çš„æ•°æ®å†™å…¥ç½‘å¡ï¼Œä¸ä¼šä½¿ç”¨ cpu

æ•´ä¸ªè¿‡ç¨‹ä»…åªå‘ç”Ÿäº†ä¸€æ¬¡ç”¨æˆ·æ€ä¸å†…æ ¸æ€çš„åˆ‡æ¢ï¼Œæ•°æ®æ‹·è´äº† 2 æ¬¡ã€‚æ‰€è°“çš„ã€é›¶æ‹·è´ã€‘ï¼Œå¹¶ä¸æ˜¯çœŸæ­£æ— æ‹·è´ï¼Œè€Œæ˜¯åœ¨ä¸ä¼šæ‹·è´é‡å¤æ•°æ®åˆ° jvm å†…å­˜ä¸­ï¼Œé›¶æ‹·è´çš„ä¼˜ç‚¹æœ‰

* æ›´å°‘çš„ç”¨æˆ·æ€ä¸å†…æ ¸æ€çš„åˆ‡æ¢
* ä¸åˆ©ç”¨ cpu è®¡ç®—ï¼Œå‡å°‘ cpu ç¼“å­˜ä¼ªå…±äº«
* é›¶æ‹·è´é€‚åˆå°æ–‡ä»¶ä¼ è¾“

##### 5.4  AIO

AIO ç”¨æ¥è§£å†³æ•°æ®å¤åˆ¶é˜¶æ®µçš„é˜»å¡é—®é¢˜

* åŒæ­¥æ„å‘³ç€ï¼Œåœ¨è¿›è¡Œè¯»å†™æ“ä½œæ—¶ï¼Œçº¿ç¨‹éœ€è¦ç­‰å¾…ç»“æœï¼Œè¿˜æ˜¯ç›¸å½“äºé—²ç½®
* å¼‚æ­¥æ„å‘³ç€ï¼Œåœ¨è¿›è¡Œè¯»å†™æ“ä½œæ—¶ï¼Œçº¿ç¨‹ä¸å¿…ç­‰å¾…ç»“æœï¼Œè€Œæ˜¯å°†æ¥ç”±æ“ä½œç³»ç»Ÿæ¥é€šè¿‡å›è°ƒæ–¹å¼ç”±å¦å¤–çš„çº¿ç¨‹æ¥è·å¾—ç»“æœ

> å¼‚æ­¥æ¨¡å‹éœ€è¦åº•å±‚æ“ä½œç³»ç»Ÿï¼ˆKernelï¼‰æä¾›æ”¯æŒ
>
> * Windows ç³»ç»Ÿé€šè¿‡ IOCP å®ç°äº†çœŸæ­£çš„å¼‚æ­¥ IO
> * Linux ç³»ç»Ÿå¼‚æ­¥ IO åœ¨ 2.6 ç‰ˆæœ¬å¼•å…¥ï¼Œä½†å…¶åº•å±‚å®ç°è¿˜æ˜¯ç”¨å¤šè·¯å¤ç”¨æ¨¡æ‹Ÿäº†å¼‚æ­¥ IOï¼Œæ€§èƒ½æ²¡æœ‰ä¼˜åŠ¿

### <font color="#23ffff">**Nettyå…¥é—¨**</font>

#### 1. æ¦‚è¿°

##### 1.1 What is Netty?

> Netty is an asynchronous event-driven network application framework for rapid development of maintainable high performance servers & clients

> Netty æ˜¯ä¸€ä¸ªå¼‚æ­¥çš„ã€åŸºäºäº‹ä»¶é©±åŠ¨çš„ç½‘ç»œåº”ç”¨æ¡†æ¶ã€ç”¨äºå¿«é€Ÿå¼€å‘å¯ç»´æŠ¤ã€é«˜æ€§èƒ½çš„ç½‘ç»œæœåŠ¡å™¨å’Œå®¢æˆ·ç«¯

##### 1.2 Netty çš„ä½œè€…

Trustin Lee ,Sorftware Engineer at LINE+ ,ä¸ä»…æ˜¯ the Founder of Netty projectï¼Œä¹Ÿæ˜¯å¦ä¸€ä¸ªè‘—åçš„ç½‘ç»œæ¡†æ¶ Mina çš„é‡è¦è´¡çŒ®è€…

> Mina

##### 1.3 Nettyçš„åœ°ä½

Netty åœ¨ Java ç½‘ç»œåº”ç”¨æ¡†æ¶ä¸­çš„åœ°ä½å°±å¥½æ¯”ï¼šSpring æ¡†æ¶åœ¨ Java EEï¼ˆJava Platform Enterprise Editionï¼‰å¼€å‘ä¸­çš„åœ°ä½

ä»¥ä¸‹æ¡†æ¶éƒ½ä½¿ç”¨äº†Nettyï¼Œå› ä¸ºå®ƒä»¬æœ‰ç½‘ç»œé€šè®¯çš„éœ€æ±‚

* Cassandra - nosqlæ•°æ®åº“
* Spark - å¤§æ•°æ®åˆ†å¸ƒå¼è®¡ç®—æ¡†æ¶
* Spring 5.x - flux api å®Œå…¨æŠ›å¼ƒäº† tomcatï¼Œä½¿ç”¨ netty ä½œä¸ºæœåŠ¡å™¨ç«¯

##### 1.4 Nettyçš„ä¼˜åŠ¿

* Netty vs NIOï¼Œå·¥ä½œé‡å¤§ï¼Œbug å¤š
  * éœ€è¦è‡ªå·±æ„å»ºåè®®
  * è§£å†³ TCP ä¼ è¾“é—®é¢˜ï¼Œå¦‚ç²˜åŒ…ã€åŠåŒ…
  * epoll ç©ºè½®è¯¢å¯¼è‡´ CPU 100%
  * å¯¹ API è¿›è¡Œå¢å¼ºï¼Œä½¿ä¹‹æ›´æ˜“ç”¨ï¼Œå¦‚ FastThreadLocal => ThreadLocalï¼ŒByteBuf => ByteBuffer
* Netty vs å…¶å®ƒç½‘ç»œåº”ç”¨æ¡†æ¶
  * Mina ç”± apache ç»´æŠ¤ï¼Œå°†æ¥ 3.x ç‰ˆæœ¬å¯èƒ½ä¼šæœ‰è¾ƒå¤§é‡æ„ï¼Œç ´å API å‘ä¸‹å…¼å®¹æ€§ï¼ŒNetty çš„å¼€å‘è¿­ä»£æ›´è¿…é€Ÿï¼ŒAPI æ›´ç®€æ´ã€æ–‡æ¡£æ›´ä¼˜ç§€
  * ä¹…ç»è€ƒéªŒï¼Œ16å¹´ï¼ŒNetty ç‰ˆæœ¬
    * 2.x 2004
    * 3.x 2008
    * 4.x 2013
    * 5.x å·²åºŸå¼ƒï¼ˆæ²¡æœ‰æ˜æ˜¾çš„æ€§èƒ½æå‡ï¼Œç»´æŠ¤æˆæœ¬é«˜ï¼‰

#### 2. Hello World

##### 2.1 ç›®æ ‡

å¼€å‘ä¸€ä¸ªç®€å•çš„æœåŠ¡å™¨ç«¯å’Œå®¢æˆ·ç«¯

* å®¢æˆ·ç«¯å‘æœåŠ¡å™¨ç«¯å‘é€ helloï¼Œworld
* æœåŠ¡å™¨ä»…æ¥æ”¶ï¼Œä¸è¿”å›

æœåŠ¡å™¨ä»£ç å®ä¾‹ï¼š

```Java
package com.r3944realms.whimsy.test;

import io.netty.bootstrap.ServerBootstrap;
import io.netty.channel.ChannelHandlerContext;
import io.netty.channel.ChannelInboundHandlerAdapter;
import io.netty.channel.ChannelInitializer;
import io.netty.channel.nio.NioEventLoopGroup;
import io.netty.channel.socket.nio.NioServerSocketChannel;
import io.netty.channel.socket.nio.NioSocketChannel;
import io.netty.handler.codec.string.StringDecoder;



public class HelloServer {
    public static void main(String[] args) {
        //1. å¯åŠ¨å™¨ï¼Œè´Ÿè´£ç»„è£…Nettyç»„ä»¶ï¼Œå¯åŠ¨æœåŠ¡å™¨
        new ServerBootstrap()
                //2. æ·»åŠ ç»„ä»¶ BossEventLoop WorkerEventLoopï¼ˆselector,threadï¼‰
                .group(new NioEventLoopGroup())
                //3. é€‰æ‹©æœåŠ¡å™¨çš„ ServerSocketChannelçš„å®ç°
                .channel(NioServerSocketChannel.class)
                //4. boss è´Ÿè´£å¤„ç†è¿æ¥ worker(child) è´Ÿè´£å¤„ç†è¯»å†™ï¼Œå†³å®šworked(child) èƒ½æ‰§è¡Œå“ªäº›æ“ä½œ (handler)
                .childHandler(
                        //5ï¼Œchannel ä»£è¡¨å’Œå®¢æˆ·ç«¯è¿›è¡Œæ•°æ®è¯»å†™çš„é€šé“ Initializer åˆå§‹åŒ–ï¼Œè´Ÿè´£æ·»åŠ åˆ«çš„ handler
                    new ChannelInitializer<NioSocketChannel>() {
                    @Override
                    protected void initChannel(NioSocketChannel ch) throws Exception {
                        //6. æ·»åŠ å…·ä½“çš„ handler
                        ch.pipeline().addLast(new StringDecoder());//å°† ByteBuf è½¬æ¢ä¸ºå­—ç¬¦ä¸²
                        ch.pipeline().addLast(new ChannelInboundHandlerAdapter() { // è‡ªå®šä¹‰ handler
                            @Override //è¯»äº‹ä»¶
                            public void channelRead(ChannelHandlerContext ctx, Object msg) throws Exception {
                                //æ‰“å°ä¸Šä¸€æ­¥è½¬æ¢çš„å¥½çš„å­—ç¬¦ä¸²
                                System.out.println(msg);
                            }
                        });
                    }
                })
                //7. ç»‘å®šç«¯å£
                .bind(9000);
    }
}

```

å®¢æˆ·ç«¯ä»£ç å®ä¾‹ï¼š

```Java
package com.r3944realms.whimsy.test;

import io.netty.bootstrap.Bootstrap;
import io.netty.channel.ChannelInitializer;
import io.netty.channel.nio.NioEventLoopGroup;
import io.netty.channel.socket.nio.NioSocketChannel;
import io.netty.handler.codec.string.StringEncoder;

public class HelloClient {
    public static void main(String[] args) throws InterruptedException {
        //1. å¯åŠ¨ç±»
        new Bootstrap()
            //2. æ·»åŠ EventLoop
                .group(new NioEventLoopGroup())
                //3. é€‰æ‹©å®¢æˆ·ç«¯Channelå®ç°
                 
                //4. æ·»åŠ å¤„ç†å™¨
                .handler(new ChannelInitializer<NioSocketChannel>() {
                    @Override // åœ¨è¿æ¥å»ºç«‹åè¢«è°ƒç”¨
                    protected void initChannel(NioSocketChannel ch) throws Exception {
                        ch.pipeline().addLast(new StringEncoder());
                    }
                })
                //5. è¿æ¥åˆ°æœåŠ¡å™¨
                .connect("localhost", 9000)
                .sync()
                .channel()
                //6. å‘æœåŠ¡å™¨å‘é€æ•°æ®
                .writeAndFlush("hello, world");
    }
}

```

##### ğŸ’¡ æç¤º

> ä¸€å¼€å§‹éœ€è¦æ ‘ç«‹æ­£ç¡®çš„è§‚å¿µ
>
> * æŠŠ channel ç†è§£ä¸º**æ•°æ®çš„é€šé“**
> * æŠŠ msg ç†è§£ä¸º**æµåŠ¨çš„æ•°æ®**ï¼Œæœ€å¼€å§‹è¾“å…¥æ˜¯ ByteBufï¼Œä½†ç»è¿‡ pipeline çš„åŠ å·¥ï¼Œä¼šå˜æˆå…¶å®ƒç±»å‹å¯¹è±¡ï¼Œæœ€åè¾“å‡ºåˆå˜æˆ ByteBuf
> * æŠŠ handler ç†è§£ä¸º**æ•°æ®çš„å¤„ç†å·¥åº**
>   * å·¥åºæœ‰å¤šé“ï¼Œåˆåœ¨ä¸€èµ·å°±æ˜¯ pipelineï¼Œpipeline è´Ÿè´£å‘å¸ƒäº‹ä»¶ï¼ˆè¯»ã€è¯»å–å®Œæˆ...ï¼‰ä¼ æ’­ç»™æ¯ä¸ª handlerï¼Œ handler å¯¹è‡ªå·±æ„Ÿå…´è¶£çš„äº‹ä»¶è¿›è¡Œå¤„ç†ï¼ˆé‡å†™äº†ç›¸åº”äº‹ä»¶å¤„ç†æ–¹æ³•ï¼‰
>   * handler åˆ† Inboundï¼ˆ å…¥ç«™ï¼‰ å’Œ Outboundï¼ˆå‡ºç«™ï¼‰ ä¸¤ç±»
> * æŠŠ eventLoop ç†è§£ä¸º**å¤„ç†æ•°æ®çš„å·¥äºº**
>   * å·¥äººå¯ä»¥ç®¡ç†å¤šä¸ª channel çš„ io æ“ä½œï¼Œå¹¶ä¸”ä¸€æ—¦å·¥äººè´Ÿè´£äº†æŸä¸ª channelï¼Œå°±è¦è´Ÿè´£åˆ°åº•ï¼ˆç»‘å®šï¼‰
>   * å·¥äººæ—¢å¯ä»¥æ‰§è¡Œ io æ“ä½œï¼Œä¹Ÿå¯ä»¥è¿›è¡Œä»»åŠ¡å¤„ç†ï¼Œæ¯ä½å·¥äººæœ‰ä»»åŠ¡é˜Ÿåˆ—ï¼Œé˜Ÿåˆ—é‡Œå¯ä»¥å †æ”¾å¤šä¸ª channel çš„å¾…å¤„ç†ä»»åŠ¡ï¼Œä»»åŠ¡åˆ†ä¸ºæ™®é€šä»»åŠ¡ã€å®šæ—¶ä»»åŠ¡
>   * å·¥äººæŒ‰ç…§ pipeline é¡ºåºï¼Œä¾æ¬¡æŒ‰ç…§ handler çš„è§„åˆ’ï¼ˆä»£ç ï¼‰å¤„ç†æ•°æ®ï¼Œå¯ä»¥ä¸ºæ¯é“å·¥åºæŒ‡å®šä¸åŒçš„å·¥äºº

#### 3. ç»„ä»¶

##### 3.1 EventLoop

**äº‹ä»¶å¾ªç¯å¯¹è±¡**

EventLoop æœ¬è´¨æ˜¯ä¸€ä¸ªå•çº¿ç¨‹æ‰§è¡Œå™¨ï¼ˆåŒæ—¶ç»´æŠ¤äº†ä¸€ä¸ª Selectorï¼‰ï¼Œé‡Œé¢æœ‰ run æ–¹æ³•å¤„ç† Channel ä¸Šæºæºä¸æ–­çš„ io äº‹ä»¶ã€‚

å®ƒçš„ç»§æ‰¿å…³ç³»æ¯”è¾ƒå¤æ‚

* ä¸€æ¡çº¿æ˜¯ç»§æ‰¿è‡ª j.u.c.ScheduledExecutorService å› æ­¤åŒ…å«äº†çº¿ç¨‹æ± ä¸­æ‰€æœ‰çš„æ–¹æ³•
* å¦ä¸€æ¡çº¿æ˜¯ç»§æ‰¿è‡ª netty è‡ªå·±çš„ OrderedEventExecutorï¼Œ
  * æä¾›äº† boolean inEventLoop(Thread thread) æ–¹æ³•åˆ¤æ–­ä¸€ä¸ªçº¿ç¨‹æ˜¯å¦å±äºæ­¤ EventLoop
  * æä¾›äº† parent æ–¹æ³•æ¥çœ‹çœ‹è‡ªå·±å±äºå“ªä¸ª EventLoopGroup

**äº‹ä»¶å¾ªç¯ç»„**

EventLoopGroup æ˜¯ä¸€ç»„ EventLoopï¼ŒChannel ä¸€èˆ¬ä¼šè°ƒç”¨ EventLoopGroup çš„ register æ–¹æ³•æ¥ç»‘å®šå…¶ä¸­ä¸€ä¸ª EventLoopï¼Œåç»­è¿™ä¸ª Channel ä¸Šçš„ io äº‹ä»¶éƒ½ç”±æ­¤ EventLoop æ¥å¤„ç†ï¼ˆä¿è¯äº† io äº‹ä»¶å¤„ç†æ—¶çš„çº¿ç¨‹å®‰å…¨ï¼‰

* ç»§æ‰¿è‡ª netty è‡ªå·±çš„ EventExecutorGroup
  * å®ç°äº† Iterable æ¥å£æä¾›éå† EventLoop çš„èƒ½åŠ›
  * å¦æœ‰ next æ–¹æ³•è·å–é›†åˆä¸­ä¸‹ä¸€ä¸ª EventLoop

###### ğŸ’¡ ä¼˜é›…å…³é—­

ä¼˜é›…å…³é—­ `shutdownGracefully` æ–¹æ³•ã€‚è¯¥æ–¹æ³•ä¼šé¦–å…ˆåˆ‡æ¢ `EventLoopGroup` åˆ°å…³é—­çŠ¶æ€ä»è€Œæ‹’ç»æ–°çš„ä»»åŠ¡çš„åŠ å…¥ï¼Œç„¶ååœ¨ä»»åŠ¡é˜Ÿåˆ—çš„ä»»åŠ¡éƒ½å¤„ç†å®Œæˆåï¼Œåœæ­¢çº¿ç¨‹çš„è¿è¡Œã€‚ä»è€Œç¡®ä¿æ•´ä½“åº”ç”¨æ˜¯åœ¨æ­£å¸¸æœ‰åºçš„çŠ¶æ€ä¸‹é€€å‡ºçš„

###### ğŸ’¡ handler æ‰§è¡Œä¸­å¦‚ä½•æ¢äººï¼Ÿ

å…³é”®ä»£ç  `io.netty.channel.AbstractChannelHandlerContext#invokeChannelRead()`

```java
static void invokeChannelRead(final AbstractChannelHandlerContext next, Object msg) {
    final Object m = next.pipeline.touch(ObjectUtil.checkNotNull(msg, "msg"), next);
    // ä¸‹ä¸€ä¸ª handler çš„äº‹ä»¶å¾ªç¯æ˜¯å¦ä¸å½“å‰çš„äº‹ä»¶å¾ªç¯æ˜¯åŒä¸€ä¸ªçº¿ç¨‹
    EventExecutor executor = next.executor();
    
    // æ˜¯ï¼Œç›´æ¥è°ƒç”¨
    if (executor.inEventLoop()) {
        next.invokeChannelRead(m);
    } 
    // ä¸æ˜¯ï¼Œå°†è¦æ‰§è¡Œçš„ä»£ç ä½œä¸ºä»»åŠ¡æäº¤ç»™ä¸‹ä¸€ä¸ªäº‹ä»¶å¾ªç¯å¤„ç†ï¼ˆæ¢äººï¼‰
    else {
        executor.execute(new Runnable() {
            @Override
            public void run() {
                next.invokeChannelRead(m);
            }
        });
    }
}
```

* å¦‚æœä¸¤ä¸ª handler ç»‘å®šçš„æ˜¯åŒä¸€ä¸ªçº¿ç¨‹ï¼Œé‚£ä¹ˆå°±ç›´æ¥è°ƒç”¨
* å¦åˆ™ï¼ŒæŠŠè¦è°ƒç”¨çš„ä»£ç å°è£…ä¸ºä¸€ä¸ªä»»åŠ¡å¯¹è±¡ï¼Œç”±ä¸‹ä¸€ä¸ª handler çš„çº¿ç¨‹æ¥è°ƒç”¨

##### 3.2 Channel

channel çš„ä¸»è¦ä½œç”¨

* close() å¯ä»¥ç”¨æ¥å…³é—­ channel
* closeFuture() ç”¨æ¥å¤„ç† channel çš„å…³é—­
  * sync æ–¹æ³•ä½œç”¨æ˜¯åŒæ­¥ç­‰å¾… channel å…³é—­
  * è€Œ addListener æ–¹æ³•æ˜¯å¼‚æ­¥ç­‰å¾… channel å…³é—­
* pipeline() æ–¹æ³•æ·»åŠ å¤„ç†å™¨
* write() æ–¹æ³•å°†æ•°æ®å†™å…¥
* writeAndFlush() æ–¹æ³•å°†æ•°æ®å†™å…¥å¹¶åˆ·å‡º

**ChannelFuture**

##### 3.3 Future & Promise

åœ¨å¼‚æ­¥å¤„ç†æ—¶ï¼Œç»å¸¸ç”¨åˆ°è¿™ä¸¤ä¸ªæ¥å£

é¦–å…ˆè¦è¯´æ˜ netty ä¸­çš„ Future ä¸ jdk ä¸­çš„ Future åŒåï¼Œä½†æ˜¯æ˜¯ä¸¤ä¸ªæ¥å£ï¼Œnetty çš„ Future ç»§æ‰¿è‡ª jdk çš„ Futureï¼Œè€Œ Promise åˆå¯¹ netty Future è¿›è¡Œäº†æ‰©å±•

* jdk Future åªèƒ½åŒæ­¥ç­‰å¾…ä»»åŠ¡ç»“æŸï¼ˆæˆ–æˆåŠŸã€æˆ–å¤±è´¥ï¼‰æ‰èƒ½å¾—åˆ°ç»“æœ
* netty Future å¯ä»¥åŒæ­¥ç­‰å¾…ä»»åŠ¡ç»“æŸå¾—åˆ°ç»“æœï¼Œä¹Ÿå¯ä»¥å¼‚æ­¥æ–¹å¼å¾—åˆ°ç»“æœï¼Œä½†éƒ½æ˜¯è¦ç­‰ä»»åŠ¡ç»“æŸ
* netty Promise ä¸ä»…æœ‰ netty Future çš„åŠŸèƒ½ï¼Œè€Œä¸”è„±ç¦»äº†ä»»åŠ¡ç‹¬ç«‹å­˜åœ¨ï¼Œåªä½œä¸ºä¸¤ä¸ªçº¿ç¨‹é—´ä¼ é€’ç»“æœçš„å®¹å™¨

| åŠŸèƒ½/åç§°    | jdk Future                     | netty Future                                                 | Promise      |
| ------------ | ------------------------------ | ------------------------------------------------------------ | ------------ |
| cancel       | å–æ¶ˆä»»åŠ¡                       | -                                                            | -            |
| isCanceled   | ä»»åŠ¡æ˜¯å¦å–æ¶ˆ                   | -                                                            | -            |
| isDone       | ä»»åŠ¡æ˜¯å¦å®Œæˆï¼Œä¸èƒ½åŒºåˆ†æˆåŠŸå¤±è´¥ | -                                                            | -            |
| get          | è·å–ä»»åŠ¡ç»“æœï¼Œé˜»å¡ç­‰å¾…         | -                                                            | -            |
| getNow       | -                              | è·å–ä»»åŠ¡ç»“æœï¼Œéé˜»å¡ï¼Œè¿˜æœªäº§ç”Ÿç»“æœæ—¶è¿”å› null                | -            |
| await        | -                              | ç­‰å¾…ä»»åŠ¡ç»“æŸï¼Œå¦‚æœä»»åŠ¡å¤±è´¥ï¼Œä¸ä¼šæŠ›å¼‚å¸¸ï¼Œè€Œæ˜¯é€šè¿‡ isSuccess åˆ¤æ–­ | -            |
| sync         | -                              | ç­‰å¾…ä»»åŠ¡ç»“æŸï¼Œå¦‚æœä»»åŠ¡å¤±è´¥ï¼ŒæŠ›å‡ºå¼‚å¸¸                         | -            |
| isSuccess    | -                              | åˆ¤æ–­ä»»åŠ¡æ˜¯å¦æˆåŠŸ                                             | -            |
| cause        | -                              | è·å–å¤±è´¥ä¿¡æ¯ï¼Œéé˜»å¡ï¼Œå¦‚æœæ²¡æœ‰å¤±è´¥ï¼Œè¿”å›null                 | -            |
| addLinstener | -                              | æ·»åŠ å›è°ƒï¼Œå¼‚æ­¥æ¥æ”¶ç»“æœ                                       | -            |
| setSuccess   | -                              | -                                                            | è®¾ç½®æˆåŠŸç»“æœ |
| setFailure   | -                              | -                                                            | è®¾ç½®å¤±è´¥ç»“æœ |

##### 3.4 Handler & Pipeline

ChannelHandler ç”¨æ¥å¤„ç† Channel ä¸Šçš„å„ç§äº‹ä»¶ï¼Œåˆ†ä¸ºå…¥ç«™ã€å‡ºç«™ä¸¤ç§ã€‚æ‰€æœ‰ ChannelHandler è¢«è¿æˆä¸€ä¸²ï¼Œå°±æ˜¯ Pipeline

* å…¥ç«™å¤„ç†å™¨é€šå¸¸æ˜¯ ChannelInboundHandlerAdapter çš„å­ç±»ï¼Œä¸»è¦ç”¨æ¥è¯»å–å®¢æˆ·ç«¯æ•°æ®ï¼Œå†™å›ç»“æœ
* å‡ºç«™å¤„ç†å™¨é€šå¸¸æ˜¯ ChannelOutboundHandlerAdapter çš„å­ç±»ï¼Œä¸»è¦å¯¹å†™å›ç»“æœè¿›è¡ŒåŠ å·¥

æ‰“ä¸ªæ¯”å–»ï¼Œæ¯ä¸ª Channel æ˜¯ä¸€ä¸ªäº§å“çš„åŠ å·¥è½¦é—´ï¼ŒPipeline æ˜¯è½¦é—´ä¸­çš„æµæ°´çº¿ï¼ŒChannelHandler å°±æ˜¯æµæ°´çº¿ä¸Šçš„å„é“å·¥åºï¼Œè€Œåé¢è¦è®²çš„ ByteBuf æ˜¯åŸææ–™ï¼Œç»è¿‡å¾ˆå¤šå·¥åºçš„åŠ å·¥ï¼šå…ˆç»è¿‡ä¸€é“é“å…¥ç«™å·¥åºï¼Œå†ç»è¿‡ä¸€é“é“å‡ºç«™å·¥åºæœ€ç»ˆå˜æˆäº§å“

Nettyæä¾›çš„æµ‹è¯•ç±»EmbeddedChannel

```Java
package top.r3944realms.whimsicality.nettyTest.test.TestPipelineAndHandler;

import io.netty.channel.*;
import io.netty.channel.embedded.EmbeddedChannel;

public class TestEmbeddedChannel {
    public static void main(String[] args) {
        ChannelInboundHandlerAdapter adapter = new ChannelInboundHandlerAdapter() {
            @Override
            public void channelRead(ChannelHandlerContext ctx, Object msg) throws Exception {
                System.out.println("1");
                super.channelRead(ctx, msg);
            }
        };
        ChannelInboundHandlerAdapter adapter2 = new ChannelInboundHandlerAdapter() {
            @Override
            public void channelRead(ChannelHandlerContext ctx, Object msg) throws Exception {
                System.out.println("2");
                super.channelRead(ctx, msg);
            }
        };
        ChannelOutboundHandlerAdapter adapter3 = new ChannelOutboundHandlerAdapter() {
            @Override
            public void write(ChannelHandlerContext ctx, Object msg, ChannelPromise promise) throws Exception {
                System.out.println("3");
                super.write(ctx, msg, promise);
            }
        };
        ChannelOutboundHandlerAdapter adapter4 = new ChannelOutboundHandlerAdapter() {
            @Override
            public void write(ChannelHandlerContext ctx, Object msg, ChannelPromise promise) throws Exception {
                System.out.println("4");
                super.write(ctx, msg, promise);
            }
        };
        EmbeddedChannel channel = new EmbeddedChannel(adapter, adapter2, adapter3, adapter4);
    }
}

```

##### 3.5 ByteBuf

æ˜¯å¯¹å­—èŠ‚æ•°æ®çš„å°è£…

###### 1ï¼‰åˆ›å»º

```java
ByteBuf buffer = ByteBufAllocator.DEFAULT.buffer(10);
log(buffer);
```

ä¸Šé¢ä»£ç åˆ›å»ºäº†ä¸€ä¸ªé»˜è®¤çš„ ByteBufï¼ˆæ± åŒ–åŸºäºç›´æ¥å†…å­˜çš„ ByteBufï¼‰ï¼Œåˆå§‹å®¹é‡æ˜¯ 10

###### 2ï¼‰ç›´æ¥å†…å­˜ vs å †å†…å­˜

å¯ä»¥ä½¿ç”¨ä¸‹é¢çš„ä»£ç æ¥åˆ›å»ºæ± åŒ–åŸºäºå †çš„ ByteBuf

```java
ByteBuf buffer = ByteBufAllocator.DEFAULT.heapBuffer(10);
```

ä¹Ÿå¯ä»¥ä½¿ç”¨ä¸‹é¢çš„ä»£ç æ¥åˆ›å»ºæ± åŒ–åŸºäºç›´æ¥å†…å­˜çš„ ByteBuf

```java
ByteBuf buffer = ByteBufAllocator.DEFAULT.directBuffer(10);
```

* ç›´æ¥å†…å­˜åˆ›å»ºå’Œé”€æ¯çš„ä»£ä»·æ˜‚è´µï¼Œä½†è¯»å†™æ€§èƒ½é«˜ï¼ˆå°‘ä¸€æ¬¡å†…å­˜å¤åˆ¶ï¼‰ï¼Œé€‚åˆé…åˆæ± åŒ–åŠŸèƒ½ä¸€èµ·ç”¨
* ç›´æ¥å†…å­˜å¯¹ GC å‹åŠ›å°ï¼Œå› ä¸ºè¿™éƒ¨åˆ†å†…å­˜ä¸å— JVM åƒåœ¾å›æ”¶çš„ç®¡ç†ï¼Œä½†ä¹Ÿè¦æ³¨æ„åŠæ—¶ä¸»åŠ¨é‡Šæ”¾

###### 3ï¼‰æ± åŒ– vs éæ± åŒ–

æ± åŒ–çš„æœ€å¤§æ„ä¹‰åœ¨äºå¯ä»¥é‡ç”¨ ByteBufï¼Œä¼˜ç‚¹æœ‰

* æ²¡æœ‰æ± åŒ–ï¼Œåˆ™æ¯æ¬¡éƒ½å¾—åˆ›å»ºæ–°çš„ ByteBuf å®ä¾‹ï¼Œè¿™ä¸ªæ“ä½œå¯¹ç›´æ¥å†…å­˜ä»£ä»·æ˜‚è´µï¼Œå°±ç®—æ˜¯å †å†…å­˜ï¼Œä¹Ÿä¼šå¢åŠ  GC å‹åŠ›
* æœ‰äº†æ± åŒ–ï¼Œåˆ™å¯ä»¥é‡ç”¨æ± ä¸­ ByteBuf å®ä¾‹ï¼Œå¹¶ä¸”é‡‡ç”¨äº†ä¸ jemalloc ç±»ä¼¼çš„å†…å­˜åˆ†é…ç®—æ³•æå‡åˆ†é…æ•ˆç‡
* é«˜å¹¶å‘æ—¶ï¼Œæ± åŒ–åŠŸèƒ½æ›´èŠ‚çº¦å†…å­˜ï¼Œå‡å°‘å†…å­˜æº¢å‡ºçš„å¯èƒ½

æ± åŒ–åŠŸèƒ½æ˜¯å¦å¼€å¯ï¼Œå¯ä»¥é€šè¿‡ä¸‹é¢çš„ç³»ç»Ÿç¯å¢ƒå˜é‡æ¥è®¾ç½®

```java
-Dio.netty.allocator.type={unpooled|pooled}
```

* 4.1 ä»¥åï¼Œé Android å¹³å°é»˜è®¤å¯ç”¨æ± åŒ–å®ç°ï¼Œ**Android å¹³å°å¯ç”¨éæ± åŒ–å®ç°**
* 4.1 ä¹‹å‰ï¼Œæ± åŒ–åŠŸèƒ½è¿˜ä¸æˆç†Ÿï¼Œé»˜è®¤æ˜¯éæ± åŒ–å®ç°

###### 4ï¼‰ç»„æˆ

ByteBuf ç”±å››éƒ¨åˆ†ç»„æˆ (æœ€å¼€å§‹è¯»å†™æŒ‡é’ˆéƒ½åœ¨ 0 ä½ç½®)

1. capacity
2. maxCapcity
3. readerIndex
4. writerIndex

åŒºåŸŸ

â€‹	**| èµ·å§‹ä½ç½® |** **<--** 

â€‹		 <u>$**åºŸå¼ƒå­—èŠ‚**$</u> 

â€‹	<- *è¯»æŒ‡é’ˆ* -

â€‹		 <u>$**å¯è¯»å­—èŠ‚**$</u>

 	<- *å†™æŒ‡é’ˆ* -

â€‹	 	<u>$**å¯å†™å­—èŠ‚**$</u> 

â€‹	<- *å®¹é‡* -

â€‹		 <u>$**å¯æ‰©å®¹å­—èŠ‚**$</u> 

â€‹	**<--** **| æœ€å¤§å®¹é‡ |**

###### 5ï¼‰å†™å…¥

æ–¹æ³•åˆ—è¡¨ï¼Œçœç•¥ä¸€äº›ä¸é‡è¦çš„æ–¹æ³•

| æ–¹æ³•ç­¾å                                                     | å«ä¹‰                   | å¤‡æ³¨                                                         |
| ------------------------------------------------------------ | ---------------------- | ------------------------------------------------------------ |
| writeBoolean(boolean value)                                  | å†™å…¥ boolean å€¼        | ç”¨ä¸€å­—èŠ‚ 01\|00 ä»£è¡¨ true\|false                             |
| writeByte(int value)                                         | å†™å…¥ byte å€¼           |                                                              |
| writeShort(int value)                                        | å†™å…¥ short å€¼          |                                                              |
| writeInt(int value)                                          | å†™å…¥ int å€¼            | Big Endianï¼Œå³ 0x250ï¼Œå†™å…¥å 00 00 02 50 **å¤§ç«¯åº**ï¼šå…ˆå†™é«˜ä½ |
| writeIntLE(int value)                                        | å†™å…¥ int å€¼            | Little Endianï¼Œå³ 0x250ï¼Œå†™å…¥å 50 02 00 00 **å°ç«¯åº**ï¼šå…ˆå†™ä½ä½ |
| writeLong(long value)                                        | å†™å…¥ long å€¼           |                                                              |
| writeChar(int value)                                         | å†™å…¥ char å€¼           |                                                              |
| writeFloat(float value)                                      | å†™å…¥ float å€¼          |                                                              |
| writeDouble(double value)                                    | å†™å…¥ double å€¼         |                                                              |
| writeBytes(ByteBuf src)                                      | å†™å…¥ netty çš„ ByteBuf  |                                                              |
| writeBytes(byte[] src)                                       | å†™å…¥ byte[]            |                                                              |
| writeBytes(ByteBuffer src)                                   | å†™å…¥ nio çš„ ByteBuffer |                                                              |
| int writeCharSequence(CharSequence sequence, Charset charset) | å†™å…¥å­—ç¬¦ä¸²             |                                                              |

> æ³¨æ„
>
> * è¿™äº›æ–¹æ³•çš„æœªæŒ‡æ˜è¿”å›å€¼çš„ï¼Œå…¶è¿”å›å€¼éƒ½æ˜¯ ByteBufï¼Œæ„å‘³ç€å¯ä»¥é“¾å¼è°ƒç”¨
> * ç½‘ç»œä¼ è¾“ï¼Œé»˜è®¤ä¹ æƒ¯æ˜¯ Big Endian

è¿˜æœ‰ä¸€ç±»æ–¹æ³•æ˜¯ set å¼€å¤´çš„ä¸€ç³»åˆ—æ–¹æ³•ï¼Œä¹Ÿå¯ä»¥å†™å…¥æ•°æ®ï¼Œä½†ä¸ä¼šæ”¹å˜å†™æŒ‡é’ˆä½ç½®

###### 6ï¼‰æ‰©å®¹

å†å†™å…¥ä¸€ä¸ª int æ•´æ•°æ—¶ï¼Œå®¹é‡ä¸å¤Ÿäº†ï¼ˆåˆå§‹å®¹é‡æ˜¯ 10ï¼‰ï¼Œè¿™æ—¶ä¼šå¼•å‘æ‰©å®¹

æ‰©å®¹è§„åˆ™æ˜¯

* å¦‚ä½•å†™å…¥åæ•°æ®å¤§å°æœªè¶…è¿‡ 512ï¼Œåˆ™é€‰æ‹©ä¸‹ä¸€ä¸ª 16 çš„æ•´æ•°å€ï¼Œä¾‹å¦‚å†™å…¥åå¤§å°ä¸º 12 ï¼Œåˆ™æ‰©å®¹å capacity æ˜¯ 16
* å¦‚æœå†™å…¥åæ•°æ®å¤§å°è¶…è¿‡ 512ï¼Œåˆ™é€‰æ‹©ä¸‹ä¸€ä¸ª 2^nï¼Œä¾‹å¦‚å†™å…¥åå¤§å°ä¸º 513ï¼Œåˆ™æ‰©å®¹å capacity æ˜¯ 2^10=1024ï¼ˆ2^9=512 å·²ç»ä¸å¤Ÿäº†ï¼‰
* æ‰©å®¹ä¸èƒ½è¶…è¿‡ max capacity ä¼šæŠ¥é”™

###### 7ï¼‰è¯»å–

è¯»è¿‡çš„å†…å®¹ï¼Œå°±å±äºåºŸå¼ƒéƒ¨åˆ†äº†ï¼Œå†è¯»åªèƒ½è¯»é‚£äº›å°šæœªè¯»å–çš„éƒ¨åˆ†

æƒ³è¦å†è¯»å–ä¸€éå·²è¯»å–è¿‡çš„åœ°æ–¹ï¼Œåªéœ€è¦åœ¨è¦è¯»å–çš„åœ°æ–¹ read å‰å…ˆåšä¸ªæ ‡è®° mark

```Java
buffer.markReaderIndex();
System.out.println(buffer.readInt());
log(buffer);
```

è¿™æ—¶è¦é‡å¤è¯»å–çš„è¯ï¼Œé‡ç½®åˆ°æ ‡è®°ä½ç½® reset

```java
buffer.resetReaderIndex();
log(buffer);
```

è¿˜æœ‰ç§åŠæ³•æ˜¯é‡‡ç”¨ get å¼€å¤´çš„ä¸€ç³»åˆ—æ–¹æ³•ï¼Œè¿™äº›æ–¹æ³•ä¸ä¼šæ”¹å˜ read index

###### 8) retain & release

ç”±äº Netty ä¸­æœ‰å †å¤–å†…å­˜çš„ ByteBuf å®ç°ï¼Œå †å¤–å†…å­˜æœ€å¥½æ˜¯æ‰‹åŠ¨æ¥é‡Šæ”¾ï¼Œè€Œä¸æ˜¯ç­‰ GC åƒåœ¾å›æ”¶ã€‚

* UnpooledHeapByteBuf ä½¿ç”¨çš„æ˜¯ JVM å†…å­˜ï¼Œåªéœ€ç­‰ GC å›æ”¶å†…å­˜å³å¯
* UnpooledDirectByteBuf ä½¿ç”¨çš„å°±æ˜¯ç›´æ¥å†…å­˜äº†ï¼Œéœ€è¦ç‰¹æ®Šçš„æ–¹æ³•æ¥å›æ”¶å†…å­˜
* PooledByteBuf å’Œå®ƒçš„å­ç±»ä½¿ç”¨äº†æ± åŒ–æœºåˆ¶ï¼Œéœ€è¦æ›´å¤æ‚çš„è§„åˆ™æ¥å›æ”¶å†…å­˜



> å›æ”¶å†…å­˜çš„æºç å®ç°ï¼Œè¯·å…³æ³¨ä¸‹é¢æ–¹æ³•çš„ä¸åŒå®ç°
>
> `protected abstract void deallocate()`



Netty è¿™é‡Œé‡‡ç”¨äº†å¼•ç”¨è®¡æ•°æ³•æ¥æ§åˆ¶å›æ”¶å†…å­˜ï¼Œæ¯ä¸ª ByteBuf éƒ½å®ç°äº† ReferenceCounted æ¥å£

* æ¯ä¸ª ByteBuf å¯¹è±¡çš„åˆå§‹è®¡æ•°ä¸º 1
* è°ƒç”¨ release æ–¹æ³•è®¡æ•°å‡ 1ï¼Œå¦‚æœè®¡æ•°ä¸º 0ï¼ŒByteBuf å†…å­˜è¢«å›æ”¶
* è°ƒç”¨ retain æ–¹æ³•è®¡æ•°åŠ  1ï¼Œè¡¨ç¤ºè°ƒç”¨è€…æ²¡ç”¨å®Œä¹‹å‰ï¼Œå…¶å®ƒ handler å³ä½¿è°ƒç”¨äº† release ä¹Ÿä¸ä¼šé€ æˆå›æ”¶
* å½“è®¡æ•°ä¸º 0 æ—¶ï¼Œåº•å±‚å†…å­˜ä¼šè¢«å›æ”¶ï¼Œè¿™æ—¶å³ä½¿ ByteBuf å¯¹è±¡è¿˜åœ¨ï¼Œå…¶å„ä¸ªæ–¹æ³•å‡æ— æ³•æ­£å¸¸ä½¿ç”¨

åŸºæœ¬è§„åˆ™æ˜¯ï¼Œ**è°æ˜¯æœ€åä½¿ç”¨è€…ï¼Œè°è´Ÿè´£ release**ï¼Œè¯¦ç»†åˆ†æå¦‚ä¸‹

* èµ·ç‚¹ï¼Œå¯¹äº NIO å®ç°æ¥è®²ï¼Œåœ¨ io.netty.channel.nio.AbstractNioByteChannel.NioByteUnsafe#read æ–¹æ³•ä¸­é¦–æ¬¡åˆ›å»º ByteBuf æ”¾å…¥ pipelineï¼ˆline 163 pipeline.fireChannelRead(byteBuf)ï¼‰
* å…¥ç«™ ByteBuf å¤„ç†åŸåˆ™
  * å¯¹åŸå§‹ ByteBuf ä¸åšå¤„ç†ï¼Œè°ƒç”¨ ctx.fireChannelRead(msg) å‘åä¼ é€’ï¼Œè¿™æ—¶æ— é¡» release
  * å°†åŸå§‹ ByteBuf è½¬æ¢ä¸ºå…¶å®ƒç±»å‹çš„ Java å¯¹è±¡ï¼Œè¿™æ—¶ ByteBuf å°±æ²¡ç”¨äº†ï¼Œå¿…é¡» release
  * å¦‚æœä¸è°ƒç”¨ ctx.fireChannelRead(msg) å‘åä¼ é€’ï¼Œé‚£ä¹ˆä¹Ÿå¿…é¡» release
  * æ³¨æ„å„ç§å¼‚å¸¸ï¼Œå¦‚æœ ByteBuf æ²¡æœ‰æˆåŠŸä¼ é€’åˆ°ä¸‹ä¸€ä¸ª ChannelHandlerï¼Œå¿…é¡» release
  * å‡è®¾æ¶ˆæ¯ä¸€ç›´å‘åä¼ ï¼Œé‚£ä¹ˆ TailContext ä¼šè´Ÿè´£é‡Šæ”¾æœªå¤„ç†æ¶ˆæ¯ï¼ˆåŸå§‹çš„ ByteBufï¼‰
* å‡ºç«™ ByteBuf å¤„ç†åŸåˆ™
  * å‡ºç«™æ¶ˆæ¯æœ€ç»ˆéƒ½ä¼šè½¬ä¸º ByteBuf è¾“å‡ºï¼Œä¸€ç›´å‘å‰ä¼ ï¼Œç”± HeadContext flush å release
* å¼‚å¸¸å¤„ç†åŸåˆ™
  * æœ‰æ—¶å€™ä¸æ¸…æ¥š ByteBuf è¢«å¼•ç”¨äº†å¤šå°‘æ¬¡ï¼Œä½†åˆå¿…é¡»å½»åº•é‡Šæ”¾ï¼Œå¯ä»¥å¾ªç¯è°ƒç”¨ release ç›´åˆ°è¿”å› true

###### 9ï¼‰slice

ã€é›¶æ‹·è´ã€‘çš„ä½“ç°ä¹‹ä¸€ï¼Œå¯¹åŸå§‹ ByteBuf è¿›è¡Œåˆ‡ç‰‡æˆå¤šä¸ª ByteBufï¼Œåˆ‡ç‰‡åçš„ ByteBuf å¹¶æ²¡æœ‰å‘ç”Ÿå†…å­˜å¤åˆ¶ï¼Œè¿˜æ˜¯ä½¿ç”¨åŸå§‹ ByteBuf çš„å†…å­˜ï¼Œåˆ‡ç‰‡åçš„ ByteBuf ç»´æŠ¤ç‹¬ç«‹çš„ readï¼Œwrite æŒ‡é’ˆ

æ— å‚ slice æ˜¯ä»åŸå§‹ ByteBuf çš„ read index åˆ° write index ä¹‹é—´çš„å†…å®¹è¿›è¡Œåˆ‡ç‰‡ï¼Œåˆ‡ç‰‡åçš„ max capacity è¢«å›ºå®šä¸ºè¿™ä¸ªåŒºé—´çš„å¤§å°ï¼Œå› æ­¤ä¸èƒ½è¿½åŠ  write

###### 10) duplicate

ã€é›¶æ‹·è´ã€‘çš„ä½“ç°ä¹‹ä¸€ï¼Œå°±å¥½æ¯”æˆªå–äº†åŸå§‹ ByteBuf æ‰€æœ‰å†…å®¹ï¼Œå¹¶ä¸”æ²¡æœ‰ max capacity çš„é™åˆ¶ï¼Œä¹Ÿæ˜¯ä¸åŸå§‹ ByteBuf ä½¿ç”¨åŒä¸€å—åº•å±‚å†…å­˜ï¼Œåªæ˜¯è¯»å†™æŒ‡é’ˆæ˜¯ç‹¬ç«‹çš„

###### 11ï¼‰copy

ä¼šå°†åº•å±‚å†…å­˜æ•°æ®è¿›è¡Œæ·±æ‹·è´ï¼Œå› æ­¤æ— è®ºè¯»å†™ï¼Œéƒ½ä¸åŸå§‹ ByteBuf æ— å…³

###### 12) CompositeByteBuf

ã€é›¶æ‹·è´ã€‘çš„ä½“ç°ä¹‹ä¸€ï¼Œå¯ä»¥å°†å¤šä¸ª ByteBuf åˆå¹¶ä¸ºä¸€ä¸ªé€»è¾‘ä¸Šçš„ ByteBufï¼Œé¿å…æ‹·è´

æœ‰ä¸¤ä¸ª ByteBuf å¦‚ä¸‹

```java
ByteBuf buf1 = ByteBufAllocator.DEFAULT.buffer(5);
buf1.writeBytes(new byte[]{1, 2, 3, 4, 5});
ByteBuf buf2 = ByteBufAllocator.DEFAULT.buffer(5);
buf2.writeBytes(new byte[]{6, 7, 8, 9, 10});
System.out.println(ByteBufUtil.prettyHexDump(buf1));
System.out.println(ByteBufUtil.prettyHexDump(buf2));
```

è¾“å‡º

```
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 01 02 03 04 05                                  |.....           |
+--------+-------------------------------------------------+----------------+
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 06 07 08 09 0a                                  |.....           |
+--------+-------------------------------------------------+----------------+
```

ç°åœ¨éœ€è¦ä¸€ä¸ªæ–°çš„ ByteBufï¼Œå†…å®¹æ¥è‡ªäºåˆšæ‰çš„ buf1 å’Œ buf2ï¼Œå¦‚ä½•å®ç°ï¼Ÿ

æ–¹æ³•1ï¼š

```java
ByteBuf buf3 = ByteBufAllocator.DEFAULT
    .buffer(buf1.readableBytes()+buf2.readableBytes());
buf3.writeBytes(buf1);
buf3.writeBytes(buf2);
System.out.println(ByteBufUtil.prettyHexDump(buf3));
```

ç»“æœ

```
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 01 02 03 04 05 06 07 08 09 0a                   |..........      |
+--------+-------------------------------------------------+----------------+
```

è¿™ç§æ–¹æ³•å¥½ä¸å¥½ï¼Ÿå›ç­”æ˜¯ä¸å¤ªå¥½ï¼Œå› ä¸ºè¿›è¡Œäº†æ•°æ®çš„å†…å­˜å¤åˆ¶æ“ä½œ



æ–¹æ³•2ï¼š

```java
CompositeByteBuf buf3 = ByteBufAllocator.DEFAULT.compositeBuffer();
// true è¡¨ç¤ºå¢åŠ æ–°çš„ ByteBuf è‡ªåŠ¨é€’å¢ write index, å¦åˆ™ write index ä¼šå§‹ç»ˆä¸º 0
buf3.addComponents(true, buf1, buf2);
```

ç»“æœæ˜¯ä¸€æ ·çš„

```
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 01 02 03 04 05 06 07 08 09 0a                   |..........      |
+--------+-------------------------------------------------+----------------+
```

CompositeByteBuf æ˜¯ä¸€ä¸ªç»„åˆçš„ ByteBufï¼Œå®ƒå†…éƒ¨ç»´æŠ¤äº†ä¸€ä¸ª Component æ•°ç»„ï¼Œæ¯ä¸ª Component ç®¡ç†ä¸€ä¸ª ByteBufï¼Œè®°å½•äº†è¿™ä¸ª ByteBuf ç›¸å¯¹äºæ•´ä½“åç§»é‡ç­‰ä¿¡æ¯ï¼Œä»£è¡¨ç€æ•´ä½“ä¸­æŸä¸€æ®µçš„æ•°æ®ã€‚

* ä¼˜ç‚¹ï¼Œå¯¹å¤–æ˜¯ä¸€ä¸ªè™šæ‹Ÿè§†å›¾ï¼Œç»„åˆè¿™äº› ByteBuf ä¸ä¼šäº§ç”Ÿå†…å­˜å¤åˆ¶
* ç¼ºç‚¹ï¼Œå¤æ‚äº†å¾ˆå¤šï¼Œå¤šæ¬¡æ“ä½œä¼šå¸¦æ¥æ€§èƒ½çš„æŸè€—

###### 13ï¼‰ Unpooled

Unpooled æ˜¯ä¸€ä¸ªå·¥å…·ç±»ï¼Œç±»å¦‚å…¶åï¼Œæä¾›äº†éæ± åŒ–çš„ ByteBuf åˆ›å»ºã€ç»„åˆã€å¤åˆ¶ç­‰æ“ä½œ

###### ğŸ’¡ ByteBuf ä¼˜åŠ¿

* æ± åŒ– - å¯ä»¥é‡ç”¨æ± ä¸­ ByteBuf å®ä¾‹ï¼Œæ›´èŠ‚çº¦å†…å­˜ï¼Œå‡å°‘å†…å­˜æº¢å‡ºçš„å¯èƒ½
* è¯»å†™æŒ‡é’ˆåˆ†ç¦»ï¼Œä¸éœ€è¦åƒ ByteBuffer ä¸€æ ·åˆ‡æ¢è¯»å†™æ¨¡å¼
* å¯ä»¥è‡ªåŠ¨æ‰©å®¹
* æ”¯æŒé“¾å¼è°ƒç”¨ï¼Œä½¿ç”¨æ›´æµç•…
* å¾ˆå¤šåœ°æ–¹ä½“ç°é›¶æ‹·è´ï¼Œä¾‹å¦‚ sliceã€duplicateã€CompositeByteBuf

#### 4.åŒå‘é€šä¿¡

å®ç°echo server

```Java
package top.r3944realms.whimsicality.nettyTest.test.echoMode;

import com.google.common.base.Charsets;
import io.netty.bootstrap.ServerBootstrap;
import io.netty.buffer.ByteBuf;
import io.netty.channel.ChannelHandlerContext;
import io.netty.channel.ChannelInboundHandlerAdapter;
import io.netty.channel.ChannelInitializer;
import io.netty.channel.ChannelPipeline;
import io.netty.channel.nio.NioEventLoopGroup;
import io.netty.channel.socket.nio.NioServerSocketChannel;
import io.netty.channel.socket.nio.NioSocketChannel;

import java.net.InetSocketAddress;

public class EchoServer {
    public static void main(String[] args) {
        new ServerBootstrap()
                .group(new NioEventLoopGroup())
                .channel(NioServerSocketChannel.class)
                .childHandler(new ChannelInitializer<NioSocketChannel>() {
                    @Override
                    protected void initChannel(NioSocketChannel ch) throws Exception {
                        ChannelPipeline pipeline = ch.pipeline();
                        pipeline.addLast(new ChannelInboundHandlerAdapter() {
                            @Override
                            public void channelRead(ChannelHandlerContext ctx, Object msg) throws Exception {
                                ByteBuf buf = (ByteBuf) msg;
                                System.out.println("[getMessage From Client] " + buf.toString(Charsets.UTF_8));
                                ByteBuf response = ctx.alloc().buffer();
                                response.writeBytes(buf);
                                ctx.writeAndFlush(response);
                            }
                        });
                    }
                }).bind(new InetSocketAddress("127.0.0.1", 9000));
    }
}
```

å®ç°echo client

```Java
package top.r3944realms.whimsicality.nettyTest.test.echoMode;

import io.netty.bootstrap.Bootstrap;
import io.netty.buffer.ByteBuf;
import io.netty.channel.*;
import io.netty.channel.nio.NioEventLoopGroup;
import io.netty.channel.socket.nio.NioSocketChannel;
import io.netty.handler.codec.string.StringEncoder;

import java.nio.charset.StandardCharsets;
import java.util.Scanner;


public class EchoClient {
    public static void main(String[] args) throws InterruptedException {
        NioEventLoopGroup group = new NioEventLoopGroup();
        Channel channel = new Bootstrap()
                .group(group)
                .channel(NioSocketChannel.class)
                .handler(new ChannelInitializer<NioSocketChannel>() {
                    @Override
                    protected void initChannel(NioSocketChannel ch) throws Exception {
                        ChannelPipeline pipeline = ch.pipeline();
                        ch.pipeline().addLast(new StringEncoder());
                        ch.pipeline().addLast(new ChannelInboundHandlerAdapter() {
                            @Override
                            public void channelRead(ChannelHandlerContext ctx, Object msg) throws Exception {
                                ByteBuf buf = (ByteBuf) msg;
                                System.out.println( "[getMessage From Server] "+ buf.toString(StandardCharsets.UTF_8));
                            }
                        });
                    }
        }).connect("127.0.0.1", 9000).sync().channel();

        channel.closeFuture().addListener(future -> {
           group.shutdownGracefully();
        });
        new Thread(() -> {
           Scanner scanner = new Scanner(System.in);
           while (true) {
               String line = scanner.next();
               if("quit".equals(line)) {
                   channel.close();
                   break;
               }
               channel.writeAndFlush(line);
           }
        }).start();
    }
}
```

### Nettyè¿›é˜¶

#### 1. ç²˜åŒ…ä¸åŠåŒ…

##### 1.1 ç²˜åŒ…ç°è±¡

æœåŠ¡ç«¯ä»£ç 

```java
public class HelloWorldServer {
    static final Logger log = LoggerFactory.getLogger(HelloWorldServer.class);
    void start() {
        NioEventLoopGroup boss = new NioEventLoopGroup(1);
        NioEventLoopGroup worker = new NioEventLoopGroup();
        try {
            ServerBootstrap serverBootstrap = new ServerBootstrap();
            serverBootstrap.channel(NioServerSocketChannel.class);
            serverBootstrap.group(boss, worker);
            serverBootstrap.childHandler(new ChannelInitializer<SocketChannel>() {
                @Override
                protected void initChannel(SocketChannel ch) throws Exception {
                    ch.pipeline().addLast(new LoggingHandler(LogLevel.DEBUG));
                    ch.pipeline().addLast(new ChannelInboundHandlerAdapter() {
                        @Override
                        public void channelActive(ChannelHandlerContext ctx) throws Exception {
                            log.debug("connected {}", ctx.channel());
                            super.channelActive(ctx);
                        }

                        @Override
                        public void channelInactive(ChannelHandlerContext ctx) throws Exception {
                            log.debug("disconnect {}", ctx.channel());
                            super.channelInactive(ctx);
                        }
                    });
                }
            });
            ChannelFuture channelFuture = serverBootstrap.bind(8080);
            log.debug("{} binding...", channelFuture.channel());
            channelFuture.sync();
            log.debug("{} bound...", channelFuture.channel());
            channelFuture.channel().closeFuture().sync();
        } catch (InterruptedException e) {
            log.error("server error", e);
        } finally {
            boss.shutdownGracefully();
            worker.shutdownGracefully();
            log.debug("stoped");
        }
    }

    public static void main(String[] args) {
        new HelloWorldServer().start();
    }
}
```

å®¢æˆ·ç«¯ä»£ç å¸Œæœ›å‘é€ 10 ä¸ªæ¶ˆæ¯ï¼Œæ¯ä¸ªæ¶ˆæ¯æ˜¯ 16 å­—èŠ‚

```java
public class HelloWorldClient {
    static final Logger log = LoggerFactory.getLogger(HelloWorldClient.class);
    public static void main(String[] args) {
        NioEventLoopGroup worker = new NioEventLoopGroup();
        try {
            Bootstrap bootstrap = new Bootstrap();
            bootstrap.channel(NioSocketChannel.class);
            bootstrap.group(worker);
            bootstrap.handler(new ChannelInitializer<SocketChannel>() {
                @Override
                protected void initChannel(SocketChannel ch) throws Exception {
                    log.debug("connetted...");
                    ch.pipeline().addLast(new ChannelInboundHandlerAdapter() {
                        @Override//ä¼šåœ¨ è¿æ¥Channel å»ºç«‹æˆåŠŸåï¼Œä¼šè§¦å‘ active äº‹ä»¶
                        public void channelActive(ChannelHandlerContext ctx) throws Exception {
                            log.debug("sending...");
                            Random r = new Random();
                            char c = 'a';
                            for (int i = 0; i < 10; i++) {
                                ByteBuf buffer = ctx.alloc().buffer();
                                buffer.writeBytes(new byte[]{0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15});
                                ctx.writeAndFlush(buffer);
                            }
                        }
                    });
                }
            });
            ChannelFuture channelFuture = bootstrap.connect("127.0.0.1", 8080).sync();
            channelFuture.channel().closeFuture().sync();

        } catch (InterruptedException e) {
            log.error("client error", e);
        } finally {
            worker.shutdownGracefully();
        }
    }
}
```

æœåŠ¡å™¨ç«¯çš„æŸæ¬¡è¾“å‡ºï¼Œå¯ä»¥çœ‹åˆ°ä¸€æ¬¡å°±æ¥æ”¶äº† 160 ä¸ªå­—èŠ‚ï¼Œè€Œéåˆ† 10 æ¬¡æ¥æ”¶

```
08:24:46 [DEBUG] [main] c.i.n.HelloWorldServer - [id: 0x81e0fda5] binding...
08:24:46 [DEBUG] [main] c.i.n.HelloWorldServer - [id: 0x81e0fda5, L:/0:0:0:0:0:0:0:0:8080] bound...
08:24:55 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0x94132411, L:/127.0.0.1:8080 - R:/127.0.0.1:58177] REGISTERED
08:24:55 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0x94132411, L:/127.0.0.1:8080 - R:/127.0.0.1:58177] ACTIVE
08:24:55 [DEBUG] [nioEventLoopGroup-3-1] c.i.n.HelloWorldServer - connected [id: 0x94132411, L:/127.0.0.1:8080 - R:/127.0.0.1:58177]
08:24:55 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0x94132411, L:/127.0.0.1:8080 - R:/127.0.0.1:58177] READ: 160B
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 00 01 02 03 04 05 06 07 08 09 0a 0b 0c 0d 0e 0f |................|
|00000010| 00 01 02 03 04 05 06 07 08 09 0a 0b 0c 0d 0e 0f |................|
|00000020| 00 01 02 03 04 05 06 07 08 09 0a 0b 0c 0d 0e 0f |................|
|00000030| 00 01 02 03 04 05 06 07 08 09 0a 0b 0c 0d 0e 0f |................|
|00000040| 00 01 02 03 04 05 06 07 08 09 0a 0b 0c 0d 0e 0f |................|
|00000050| 00 01 02 03 04 05 06 07 08 09 0a 0b 0c 0d 0e 0f |................|
|00000060| 00 01 02 03 04 05 06 07 08 09 0a 0b 0c 0d 0e 0f |................|
|00000070| 00 01 02 03 04 05 06 07 08 09 0a 0b 0c 0d 0e 0f |................|
|00000080| 00 01 02 03 04 05 06 07 08 09 0a 0b 0c 0d 0e 0f |................|
|00000090| 00 01 02 03 04 05 06 07 08 09 0a 0b 0c 0d 0e 0f |................|
+--------+-------------------------------------------------+----------------+
08:24:55 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0x94132411, L:/127.0.0.1:8080 - R:/127.0.0.1:58177] READ COMPLETE
```

##### 1.2 åŠåŒ…ç°è±¡

å®¢æˆ·ç«¯ä»£ç å¸Œæœ›å‘é€ 1 ä¸ªæ¶ˆæ¯ï¼Œè¿™ä¸ªæ¶ˆæ¯æ˜¯ 160 å­—èŠ‚ï¼Œä»£ç æ”¹ä¸º

```java
ByteBuf buffer = ctx.alloc().buffer();
for (int i = 0; i < 10; i++) {
    buffer.writeBytes(new byte[]{0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15});
}
ctx.writeAndFlush(buffer);
```

ä¸ºç°è±¡æ˜æ˜¾ï¼ŒæœåŠ¡ç«¯ä¿®æ”¹ä¸€ä¸‹æ¥æ”¶ç¼“å†²åŒºï¼Œå…¶å®ƒä»£ç ä¸å˜

```java
serverBootstrap.option(ChannelOption.SO_RCVBUF, 10);
```

æœåŠ¡å™¨ç«¯çš„æŸæ¬¡è¾“å‡ºï¼Œå¯ä»¥çœ‹åˆ°æ¥æ”¶çš„æ¶ˆæ¯è¢«åˆ†ä¸ºä¸¤èŠ‚ï¼Œç¬¬ä¸€æ¬¡ 20 å­—èŠ‚ï¼Œç¬¬äºŒæ¬¡ 140 å­—èŠ‚

```
08:43:49 [DEBUG] [main] c.i.n.HelloWorldServer - [id: 0x4d6c6a84] binding...
08:43:49 [DEBUG] [main] c.i.n.HelloWorldServer - [id: 0x4d6c6a84, L:/0:0:0:0:0:0:0:0:8080] bound...
08:44:23 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0x1719abf7, L:/127.0.0.1:8080 - R:/127.0.0.1:59221] REGISTERED
08:44:23 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0x1719abf7, L:/127.0.0.1:8080 - R:/127.0.0.1:59221] ACTIVE
08:44:23 [DEBUG] [nioEventLoopGroup-3-1] c.i.n.HelloWorldServer - connected [id: 0x1719abf7, L:/127.0.0.1:8080 - R:/127.0.0.1:59221]
08:44:24 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0x1719abf7, L:/127.0.0.1:8080 - R:/127.0.0.1:59221] READ: 20B
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 00 01 02 03 04 05 06 07 08 09 0a 0b 0c 0d 0e 0f |................|
|00000010| 00 01 02 03                                     |....            |
+--------+-------------------------------------------------+----------------+
08:44:24 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0x1719abf7, L:/127.0.0.1:8080 - R:/127.0.0.1:59221] READ COMPLETE
08:44:24 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0x1719abf7, L:/127.0.0.1:8080 - R:/127.0.0.1:59221] READ: 140B
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 04 05 06 07 08 09 0a 0b 0c 0d 0e 0f 00 01 02 03 |................|
|00000010| 04 05 06 07 08 09 0a 0b 0c 0d 0e 0f 00 01 02 03 |................|
|00000020| 04 05 06 07 08 09 0a 0b 0c 0d 0e 0f 00 01 02 03 |................|
|00000030| 04 05 06 07 08 09 0a 0b 0c 0d 0e 0f 00 01 02 03 |................|
|00000040| 04 05 06 07 08 09 0a 0b 0c 0d 0e 0f 00 01 02 03 |................|
|00000050| 04 05 06 07 08 09 0a 0b 0c 0d 0e 0f 00 01 02 03 |................|
|00000060| 04 05 06 07 08 09 0a 0b 0c 0d 0e 0f 00 01 02 03 |................|
|00000070| 04 05 06 07 08 09 0a 0b 0c 0d 0e 0f 00 01 02 03 |................|
|00000080| 04 05 06 07 08 09 0a 0b 0c 0d 0e 0f             |............    |
+--------+-------------------------------------------------+----------------+
08:44:24 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0x1719abf7, L:/127.0.0.1:8080 - R:/127.0.0.1:59221] READ COMPLETE
```

> **æ³¨æ„**
>
> serverBootstrap.option(ChannelOption.SO_RCVBUF, 10) å½±å“çš„åº•å±‚æ¥æ”¶ç¼“å†²åŒºï¼ˆå³æ»‘åŠ¨çª—å£ï¼‰å¤§å°ï¼Œä»…å†³å®šäº† netty è¯»å–çš„æœ€å°å•ä½ï¼Œnetty å®é™…æ¯æ¬¡è¯»å–çš„ä¸€èˆ¬æ˜¯å®ƒçš„æ•´æ•°å€

##### 1.3 ç°è±¡åˆ†æ

ç²˜åŒ…

* ç°è±¡ï¼Œå‘é€ abc defï¼Œæ¥æ”¶ abcdef
* åŸå› 
  * åº”ç”¨å±‚ï¼šæ¥æ”¶æ–¹ ByteBuf è®¾ç½®å¤ªå¤§ï¼ˆNetty é»˜è®¤ 1024ï¼‰
  * æ»‘åŠ¨çª—å£ï¼šå‡è®¾å‘é€æ–¹ 256 bytes è¡¨ç¤ºä¸€ä¸ªå®Œæ•´æŠ¥æ–‡ï¼Œä½†ç”±äºæ¥æ”¶æ–¹å¤„ç†ä¸åŠæ—¶ä¸”çª—å£å¤§å°è¶³å¤Ÿå¤§ï¼Œè¿™ 256 bytes å­—èŠ‚å°±ä¼šç¼“å†²åœ¨æ¥æ”¶æ–¹çš„æ»‘åŠ¨çª—å£ä¸­ï¼Œå½“æ»‘åŠ¨çª—å£ä¸­ç¼“å†²äº†å¤šä¸ªæŠ¥æ–‡å°±ä¼šç²˜åŒ…
  * Nagle ç®—æ³•ï¼šä¼šé€ æˆç²˜åŒ…(å°½å¯èƒ½çš„å¤šçš„æ•°æ®é‡å‘é€å‡ºå»)

åŠåŒ…

* ç°è±¡ï¼Œå‘é€ abcdefï¼Œæ¥æ”¶ abc def
* åŸå› 
  * åº”ç”¨å±‚ï¼šæ¥æ”¶æ–¹ ByteBuf å°äºå®é™…å‘é€æ•°æ®é‡
  * æ»‘åŠ¨çª—å£ï¼šå‡è®¾æ¥æ”¶æ–¹çš„çª—å£åªå‰©äº† 128 bytesï¼Œå‘é€æ–¹çš„æŠ¥æ–‡å¤§å°æ˜¯ 256 bytesï¼Œè¿™æ—¶æ”¾ä¸ä¸‹äº†ï¼Œåªèƒ½å…ˆå‘é€å‰ 128 bytesï¼Œç­‰å¾… ack åæ‰èƒ½å‘é€å‰©ä½™éƒ¨åˆ†ï¼Œè¿™å°±é€ æˆäº†åŠåŒ…
  * MSS é™åˆ¶ï¼šå½“å‘é€çš„æ•°æ®è¶…è¿‡ MSS é™åˆ¶åï¼Œä¼šå°†æ•°æ®åˆ‡åˆ†å‘é€ï¼Œå°±ä¼šé€ æˆåŠåŒ…



æœ¬è´¨æ˜¯å› ä¸º TCP æ˜¯æµå¼åè®®ï¼Œæ¶ˆæ¯æ— è¾¹ç•Œ

##### 1.4 è§£å†³æ–¹æ¡ˆ

1. çŸ­é“¾æ¥ï¼Œå‘ä¸€ä¸ªåŒ…å»ºç«‹ä¸€æ¬¡è¿æ¥ï¼Œè¿™æ ·è¿æ¥å»ºç«‹åˆ°è¿æ¥æ–­å¼€ä¹‹é—´å°±æ˜¯æ¶ˆæ¯çš„è¾¹ç•Œï¼Œç¼ºç‚¹æ•ˆç‡å¤ªä½
2. æ¯ä¸€æ¡æ¶ˆæ¯é‡‡ç”¨å›ºå®šé•¿åº¦ï¼Œç¼ºç‚¹æµªè´¹ç©ºé—´
3. æ¯ä¸€æ¡æ¶ˆæ¯é‡‡ç”¨åˆ†éš”ç¬¦ï¼Œä¾‹å¦‚ \nï¼Œç¼ºç‚¹éœ€è¦è½¬ä¹‰
4. æ¯ä¸€æ¡æ¶ˆæ¯åˆ†ä¸º head å’Œ bodyï¼Œhead ä¸­åŒ…å« body çš„é•¿åº¦

###### æ–¹æ³•1ï¼ŒçŸ­é“¾æ¥

ä»¥è§£å†³ç²˜åŒ…ä¸ºä¾‹

```java
public class HelloWorldClient {
    static final Logger log = LoggerFactory.getLogger(HelloWorldClient.class);

    public static void main(String[] args) {
        // åˆ† 10 æ¬¡å‘é€
        for (int i = 0; i < 10; i++) {
            send();
        }
    }

    private static void send() {
        NioEventLoopGroup worker = new NioEventLoopGroup();
        try {
            Bootstrap bootstrap = new Bootstrap();
            bootstrap.channel(NioSocketChannel.class);
            bootstrap.group(worker);
            bootstrap.handler(new ChannelInitializer<SocketChannel>() {
                @Override
                protected void initChannel(SocketChannel ch) throws Exception {
                    log.debug("conneted...");
                    ch.pipeline().addLast(new LoggingHandler(LogLevel.DEBUG));
                    ch.pipeline().addLast(new ChannelInboundHandlerAdapter() {
                        @Override
                        public void channelActive(ChannelHandlerContext ctx) throws Exception {
                            log.debug("sending...");
                            ByteBuf buffer = ctx.alloc().buffer();
                            buffer.writeBytes(new byte[]{0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15});
                            ctx.writeAndFlush(buffer);
                            // å‘å®Œå³å…³
                            ctx.close();
                        }
                    });
                }
            });
            ChannelFuture channelFuture = bootstrap.connect("localhost", 8080).sync();
            channelFuture.channel().closeFuture().sync();

        } catch (InterruptedException e) {
            log.error("client error", e);
        } finally {
            worker.shutdownGracefully();
        }
    }
}
```

è¾“å‡ºï¼Œç•¥

> åŠåŒ…ç”¨è¿™ç§åŠæ³•è¿˜æ˜¯ä¸å¥½è§£å†³ï¼Œ**å› ä¸ºæ¥æ”¶æ–¹çš„ç¼“å†²åŒºå¤§å°æ˜¯æœ‰é™çš„**

###### æ–¹æ³•2ï¼Œå›ºå®šé•¿åº¦

è®©æ‰€æœ‰æ•°æ®åŒ…é•¿åº¦å›ºå®šï¼ˆå‡è®¾é•¿åº¦ä¸º 8 å­—èŠ‚ï¼‰ï¼ŒæœåŠ¡å™¨ç«¯åŠ å…¥

```java
ch.pipeline().addLast(new FixedLengthFrameDecoder(8));
```

å®¢æˆ·ç«¯æµ‹è¯•ä»£ç ï¼Œæ³¨æ„, é‡‡ç”¨è¿™ç§æ–¹æ³•åï¼Œå®¢æˆ·ç«¯ä»€ä¹ˆæ—¶å€™ flush éƒ½å¯ä»¥

```java
public class HelloWorldClient {
    static final Logger log = LoggerFactory.getLogger(HelloWorldClient.class);

    public static void main(String[] args) {
        NioEventLoopGroup worker = new NioEventLoopGroup();
        try {
            Bootstrap bootstrap = new Bootstrap();
            bootstrap.channel(NioSocketChannel.class);
            bootstrap.group(worker);
            bootstrap.handler(new ChannelInitializer<SocketChannel>() {
                @Override
                protected void initChannel(SocketChannel ch) throws Exception {
                    log.debug("connetted...");
                    ch.pipeline().addLast(new LoggingHandler(LogLevel.DEBUG));
                    ch.pipeline().addLast(new ChannelInboundHandlerAdapter() {
                        @Override
                        public void channelActive(ChannelHandlerContext ctx) throws Exception {
                            log.debug("sending...");
                            // å‘é€å†…å®¹éšæœºçš„æ•°æ®åŒ…
                            Random r = new Random();
                            char c = 'a';
                            ByteBuf buffer = ctx.alloc().buffer();
                            for (int i = 0; i < 10; i++) {
                                byte[] bytes = new byte[8];
                                for (int j = 0; j < r.nextInt(8); j++) {
                                    bytes[j] = (byte) c;
                                }
                                c++;
                                buffer.writeBytes(bytes);
                            }
                            ctx.writeAndFlush(buffer);
                        }
                    });
                }
            });
            ChannelFuture channelFuture = bootstrap.connect("192.168.0.103", 9090).sync();
            channelFuture.channel().closeFuture().sync();

        } catch (InterruptedException e) {
            log.error("client error", e);
        } finally {
            worker.shutdownGracefully();
        }
    }
}
```

å®¢æˆ·ç«¯è¾“å‡º

```
12:07:00 [DEBUG] [nioEventLoopGroup-2-1] c.i.n.HelloWorldClient - connetted...
12:07:00 [DEBUG] [nioEventLoopGroup-2-1] i.n.h.l.LoggingHandler - [id: 0x3c2ef3c2] REGISTERED
12:07:00 [DEBUG] [nioEventLoopGroup-2-1] i.n.h.l.LoggingHandler - [id: 0x3c2ef3c2] CONNECT: /192.168.0.103:9090
12:07:00 [DEBUG] [nioEventLoopGroup-2-1] i.n.h.l.LoggingHandler - [id: 0x3c2ef3c2, L:/192.168.0.103:53155 - R:/192.168.0.103:9090] ACTIVE
12:07:00 [DEBUG] [nioEventLoopGroup-2-1] c.i.n.HelloWorldClient - sending...
12:07:00 [DEBUG] [nioEventLoopGroup-2-1] i.n.h.l.LoggingHandler - [id: 0x3c2ef3c2, L:/192.168.0.103:53155 - R:/192.168.0.103:9090] WRITE: 80B
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 61 61 61 61 00 00 00 00 62 00 00 00 00 00 00 00 |aaaa....b.......|
|00000010| 63 63 00 00 00 00 00 00 64 00 00 00 00 00 00 00 |cc......d.......|
|00000020| 00 00 00 00 00 00 00 00 66 66 66 66 00 00 00 00 |........ffff....|
|00000030| 67 67 67 00 00 00 00 00 68 00 00 00 00 00 00 00 |ggg.....h.......|
|00000040| 69 69 69 69 69 00 00 00 6a 6a 6a 6a 00 00 00 00 |iiiii...jjjj....|
+--------+-------------------------------------------------+----------------+
12:07:00 [DEBUG] [nioEventLoopGroup-2-1] i.n.h.l.LoggingHandler - [id: 0x3c2ef3c2, L:/192.168.0.103:53155 - R:/192.168.0.103:9090] FLUSH
```

æœåŠ¡ç«¯è¾“å‡º

```
12:06:51 [DEBUG] [main] c.i.n.HelloWorldServer - [id: 0xe3d9713f] binding...
12:06:51 [DEBUG] [main] c.i.n.HelloWorldServer - [id: 0xe3d9713f, L:/192.168.0.103:9090] bound...
12:07:00 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0xd739f137, L:/192.168.0.103:9090 - R:/192.168.0.103:53155] REGISTERED
12:07:00 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0xd739f137, L:/192.168.0.103:9090 - R:/192.168.0.103:53155] ACTIVE
12:07:00 [DEBUG] [nioEventLoopGroup-3-1] c.i.n.HelloWorldServer - connected [id: 0xd739f137, L:/192.168.0.103:9090 - R:/192.168.0.103:53155]
12:07:00 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0xd739f137, L:/192.168.0.103:9090 - R:/192.168.0.103:53155] READ: 8B
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 61 61 61 61 00 00 00 00                         |aaaa....        |
+--------+-------------------------------------------------+----------------+
12:07:00 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0xd739f137, L:/192.168.0.103:9090 - R:/192.168.0.103:53155] READ: 8B
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 62 00 00 00 00 00 00 00                         |b.......        |
+--------+-------------------------------------------------+----------------+
12:07:00 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0xd739f137, L:/192.168.0.103:9090 - R:/192.168.0.103:53155] READ: 8B
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 63 63 00 00 00 00 00 00                         |cc......        |
+--------+-------------------------------------------------+----------------+
12:07:00 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0xd739f137, L:/192.168.0.103:9090 - R:/192.168.0.103:53155] READ: 8B
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 64 00 00 00 00 00 00 00                         |d.......        |
+--------+-------------------------------------------------+----------------+
12:07:00 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0xd739f137, L:/192.168.0.103:9090 - R:/192.168.0.103:53155] READ: 8B
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 00 00 00 00 00 00 00 00                         |........        |
+--------+-------------------------------------------------+----------------+
12:07:00 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0xd739f137, L:/192.168.0.103:9090 - R:/192.168.0.103:53155] READ: 8B
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 66 66 66 66 00 00 00 00                         |ffff....        |
+--------+-------------------------------------------------+----------------+
12:07:00 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0xd739f137, L:/192.168.0.103:9090 - R:/192.168.0.103:53155] READ: 8B
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 67 67 67 00 00 00 00 00                         |ggg.....        |
+--------+-------------------------------------------------+----------------+
12:07:00 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0xd739f137, L:/192.168.0.103:9090 - R:/192.168.0.103:53155] READ: 8B
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 68 00 00 00 00 00 00 00                         |h.......        |
+--------+-------------------------------------------------+----------------+
12:07:00 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0xd739f137, L:/192.168.0.103:9090 - R:/192.168.0.103:53155] READ: 8B
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 69 69 69 69 69 00 00 00                         |iiiii...        |
+--------+-------------------------------------------------+----------------+
12:07:00 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0xd739f137, L:/192.168.0.103:9090 - R:/192.168.0.103:53155] READ: 8B
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 6a 6a 6a 6a 00 00 00 00                         |jjjj....        |
+--------+-------------------------------------------------+----------------+
12:07:00 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0xd739f137, L:/192.168.0.103:9090 - R:/192.168.0.103:53155] READ COMPLETE
```

ç¼ºç‚¹æ˜¯ï¼Œæ•°æ®åŒ…çš„å¤§å°ä¸å¥½æŠŠæ¡

* é•¿åº¦å®šçš„å¤ªå¤§ï¼Œæµªè´¹
* é•¿åº¦å®šçš„å¤ªå°ï¼Œå¯¹æŸäº›æ•°æ®åŒ…åˆæ˜¾å¾—ä¸å¤Ÿ

###### æ–¹æ³•3ï¼Œå›ºå®šåˆ†éš”ç¬¦

æœåŠ¡ç«¯åŠ å…¥ï¼Œé»˜è®¤ä»¥ \n æˆ– \r\n ä½œä¸ºåˆ†éš”ç¬¦ï¼Œå¦‚æœè¶…å‡ºæŒ‡å®šé•¿åº¦ä»æœªå‡ºç°åˆ†éš”ç¬¦ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸

```java
ch.pipeline().addLast(new LineBasedFrameDecoder(1024));
```

å®¢æˆ·ç«¯åœ¨æ¯æ¡æ¶ˆæ¯ä¹‹åï¼ŒåŠ å…¥ \n åˆ†éš”ç¬¦

```java
public class HelloWorldClient {
    static final Logger log = LoggerFactory.getLogger(HelloWorldClient.class);

    public static void main(String[] args) {
        NioEventLoopGroup worker = new NioEventLoopGroup();
        try {
            Bootstrap bootstrap = new Bootstrap();
            bootstrap.channel(NioSocketChannel.class);
            bootstrap.group(worker);
            bootstrap.handler(new ChannelInitializer<SocketChannel>() {
                @Override
                protected void initChannel(SocketChannel ch) throws Exception {
                    log.debug("connetted...");
                    ch.pipeline().addLast(new LoggingHandler(LogLevel.DEBUG));
                    ch.pipeline().addLast(new ChannelInboundHandlerAdapter() {
                        @Override
                        public void channelActive(ChannelHandlerContext ctx) throws Exception {
                            log.debug("sending...");
                            Random r = new Random();
                            char c = 'a';
                            ByteBuf buffer = ctx.alloc().buffer();
                            for (int i = 0; i < 10; i++) {
                                for (int j = 1; j <= r.nextInt(16)+1; j++) {
                                    buffer.writeByte((byte) c);
                                }
                                buffer.writeByte(10);
                                c++;
                            }
                            ctx.writeAndFlush(buffer);
                        }
                    });
                }
            });
            ChannelFuture channelFuture = bootstrap.connect("192.168.0.103", 9090).sync();
            channelFuture.channel().closeFuture().sync();

        } catch (InterruptedException e) {
            log.error("client error", e);
        } finally {
            worker.shutdownGracefully();
        }
    }
}
```

å®¢æˆ·ç«¯è¾“å‡º

```
14:08:18 [DEBUG] [nioEventLoopGroup-2-1] c.i.n.HelloWorldClient - connetted...
14:08:18 [DEBUG] [nioEventLoopGroup-2-1] i.n.h.l.LoggingHandler - [id: 0x1282d755] REGISTERED
14:08:18 [DEBUG] [nioEventLoopGroup-2-1] i.n.h.l.LoggingHandler - [id: 0x1282d755] CONNECT: /192.168.0.103:9090
14:08:18 [DEBUG] [nioEventLoopGroup-2-1] i.n.h.l.LoggingHandler - [id: 0x1282d755, L:/192.168.0.103:63641 - R:/192.168.0.103:9090] ACTIVE
14:08:18 [DEBUG] [nioEventLoopGroup-2-1] c.i.n.HelloWorldClient - sending...
14:08:18 [DEBUG] [nioEventLoopGroup-2-1] i.n.h.l.LoggingHandler - [id: 0x1282d755, L:/192.168.0.103:63641 - R:/192.168.0.103:9090] WRITE: 60B
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 61 0a 62 62 62 0a 63 63 63 0a 64 64 0a 65 65 65 |a.bbb.ccc.dd.eee|
|00000010| 65 65 65 65 65 65 65 0a 66 66 0a 67 67 67 67 67 |eeeeeee.ff.ggggg|
|00000020| 67 67 0a 68 68 68 68 0a 69 69 69 69 69 69 69 0a |gg.hhhh.iiiiiii.|
|00000030| 6a 6a 6a 6a 6a 6a 6a 6a 6a 6a 6a 0a             |jjjjjjjjjjj.    |
+--------+-------------------------------------------------+----------------+
14:08:18 [DEBUG] [nioEventLoopGroup-2-1] i.n.h.l.LoggingHandler - [id: 0x1282d755, L:/192.168.0.103:63641 - R:/192.168.0.103:9090] FLUSH
```



æœåŠ¡ç«¯è¾“å‡º

```
14:08:18 [DEBUG] [nioEventLoopGroup-3-5] c.i.n.HelloWorldServer - connected [id: 0xa4b3be43, L:/192.168.0.103:9090 - R:/192.168.0.103:63641]
14:08:18 [DEBUG] [nioEventLoopGroup-3-5] i.n.h.l.LoggingHandler - [id: 0xa4b3be43, L:/192.168.0.103:9090 - R:/192.168.0.103:63641] READ: 1B
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 61                                              |a               |
+--------+-------------------------------------------------+----------------+
14:08:18 [DEBUG] [nioEventLoopGroup-3-5] i.n.h.l.LoggingHandler - [id: 0xa4b3be43, L:/192.168.0.103:9090 - R:/192.168.0.103:63641] READ: 3B
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 62 62 62                                        |bbb             |
+--------+-------------------------------------------------+----------------+
14:08:18 [DEBUG] [nioEventLoopGroup-3-5] i.n.h.l.LoggingHandler - [id: 0xa4b3be43, L:/192.168.0.103:9090 - R:/192.168.0.103:63641] READ: 3B
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 63 63 63                                        |ccc             |
+--------+-------------------------------------------------+----------------+
14:08:18 [DEBUG] [nioEventLoopGroup-3-5] i.n.h.l.LoggingHandler - [id: 0xa4b3be43, L:/192.168.0.103:9090 - R:/192.168.0.103:63641] READ: 2B
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 64 64                                           |dd              |
+--------+-------------------------------------------------+----------------+
14:08:18 [DEBUG] [nioEventLoopGroup-3-5] i.n.h.l.LoggingHandler - [id: 0xa4b3be43, L:/192.168.0.103:9090 - R:/192.168.0.103:63641] READ: 10B
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 65 65 65 65 65 65 65 65 65 65                   |eeeeeeeeee      |
+--------+-------------------------------------------------+----------------+
14:08:18 [DEBUG] [nioEventLoopGroup-3-5] i.n.h.l.LoggingHandler - [id: 0xa4b3be43, L:/192.168.0.103:9090 - R:/192.168.0.103:63641] READ: 2B
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 66 66                                           |ff              |
+--------+-------------------------------------------------+----------------+
14:08:18 [DEBUG] [nioEventLoopGroup-3-5] i.n.h.l.LoggingHandler - [id: 0xa4b3be43, L:/192.168.0.103:9090 - R:/192.168.0.103:63641] READ: 7B
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 67 67 67 67 67 67 67                            |ggggggg         |
+--------+-------------------------------------------------+----------------+
14:08:18 [DEBUG] [nioEventLoopGroup-3-5] i.n.h.l.LoggingHandler - [id: 0xa4b3be43, L:/192.168.0.103:9090 - R:/192.168.0.103:63641] READ: 4B
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 68 68 68 68                                     |hhhh            |
+--------+-------------------------------------------------+----------------+
14:08:18 [DEBUG] [nioEventLoopGroup-3-5] i.n.h.l.LoggingHandler - [id: 0xa4b3be43, L:/192.168.0.103:9090 - R:/192.168.0.103:63641] READ: 7B
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 69 69 69 69 69 69 69                            |iiiiiii         |
+--------+-------------------------------------------------+----------------+
14:08:18 [DEBUG] [nioEventLoopGroup-3-5] i.n.h.l.LoggingHandler - [id: 0xa4b3be43, L:/192.168.0.103:9090 - R:/192.168.0.103:63641] READ: 11B
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 6a 6a 6a 6a 6a 6a 6a 6a 6a 6a 6a                |jjjjjjjjjjj     |
+--------+-------------------------------------------------+----------------+
14:08:18 [DEBUG] [nioEventLoopGroup-3-5] i.n.h.l.LoggingHandler - [id: 0xa4b3be43, L:/192.168.0.103:9090 - R:/192.168.0.103:63641] READ COMPLETE
```

ç¼ºç‚¹ï¼Œå¤„ç†å­—ç¬¦æ•°æ®æ¯”è¾ƒåˆé€‚ï¼Œä½†å¦‚æœå†…å®¹æœ¬èº«åŒ…å«äº†åˆ†éš”ç¬¦ï¼ˆå­—èŠ‚æ•°æ®å¸¸å¸¸ä¼šæœ‰æ­¤æƒ…å†µï¼‰ï¼Œé‚£ä¹ˆå°±ä¼šè§£æé”™è¯¯

###### æ–¹æ³•4ï¼Œé¢„è®¾é•¿åº¦

åœ¨å‘é€æ¶ˆæ¯å‰ï¼Œå…ˆçº¦å®šç”¨å®šé•¿å­—èŠ‚è¡¨ç¤ºæ¥ä¸‹æ¥æ•°æ®çš„é•¿åº¦å»ºè®®å»çœ‹LengthFieldBasedFrameDecoderæºç Docs

```java
// æœ€å¤§é•¿åº¦ï¼Œé•¿åº¦åç§»ï¼Œé•¿åº¦å ç”¨å­—èŠ‚ï¼Œé•¿åº¦è°ƒæ•´ï¼Œå‰¥ç¦»å­—èŠ‚æ•°
ch.pipeline().addLast(new LengthFieldBasedFrameDecoder(1024, 0, 1, 0, 1));
```

å®¢æˆ·ç«¯ä»£ç 

```java
public class HelloWorldClient {
    static final Logger log = LoggerFactory.getLogger(HelloWorldClient.class);

    public static void main(String[] args) {
        NioEventLoopGroup worker = new NioEventLoopGroup();
        try {
            Bootstrap bootstrap = new Bootstrap();
            bootstrap.channel(NioSocketChannel.class);
            bootstrap.group(worker);
            bootstrap.handler(new ChannelInitializer<SocketChannel>() {
                @Override
                protected void initChannel(SocketChannel ch) throws Exception {
                    log.debug("connetted...");
                    ch.pipeline().addLast(new LoggingHandler(LogLevel.DEBUG));
                    ch.pipeline().addLast(new ChannelInboundHandlerAdapter() {
                        @Override
                        public void channelActive(ChannelHandlerContext ctx) throws Exception {
                            log.debug("sending...");
                            Random r = new Random();
                            char c = 'a';
                            ByteBuf buffer = ctx.alloc().buffer();
                            for (int i = 0; i < 10; i++) {
                                byte length = (byte) (r.nextInt(16) + 1);
                                // å…ˆå†™å…¥é•¿åº¦
                                buffer.writeByte(length);
                                // å†
                                for (int j = 1; j <= length; j++) {
                                    buffer.writeByte((byte) c);
                                }
                                c++;
                            }
                            ctx.writeAndFlush(buffer);
                        }
                    });
                }
            });
            ChannelFuture channelFuture = bootstrap.connect("192.168.0.103", 9090).sync();
            channelFuture.channel().closeFuture().sync();

        } catch (InterruptedException e) {
            log.error("client error", e);
        } finally {
            worker.shutdownGracefully();
        }
    }
}
```



å®¢æˆ·ç«¯è¾“å‡º

```
14:37:10 [DEBUG] [nioEventLoopGroup-2-1] c.i.n.HelloWorldClient - connetted...
14:37:10 [DEBUG] [nioEventLoopGroup-2-1] i.n.h.l.LoggingHandler - [id: 0xf0f347b8] REGISTERED
14:37:10 [DEBUG] [nioEventLoopGroup-2-1] i.n.h.l.LoggingHandler - [id: 0xf0f347b8] CONNECT: /192.168.0.103:9090
14:37:10 [DEBUG] [nioEventLoopGroup-2-1] i.n.h.l.LoggingHandler - [id: 0xf0f347b8, L:/192.168.0.103:49979 - R:/192.168.0.103:9090] ACTIVE
14:37:10 [DEBUG] [nioEventLoopGroup-2-1] c.i.n.HelloWorldClient - sending...
14:37:10 [DEBUG] [nioEventLoopGroup-2-1] i.n.h.l.LoggingHandler - [id: 0xf0f347b8, L:/192.168.0.103:49979 - R:/192.168.0.103:9090] WRITE: 97B
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 09 61 61 61 61 61 61 61 61 61 09 62 62 62 62 62 |.aaaaaaaaa.bbbbb|
|00000010| 62 62 62 62 06 63 63 63 63 63 63 08 64 64 64 64 |bbbb.cccccc.dddd|
|00000020| 64 64 64 64 0f 65 65 65 65 65 65 65 65 65 65 65 |dddd.eeeeeeeeeee|
|00000030| 65 65 65 65 0d 66 66 66 66 66 66 66 66 66 66 66 |eeee.fffffffffff|
|00000040| 66 66 02 67 67 02 68 68 0e 69 69 69 69 69 69 69 |ff.gg.hh.iiiiiii|
|00000050| 69 69 69 69 69 69 69 09 6a 6a 6a 6a 6a 6a 6a 6a |iiiiiii.jjjjjjjj|
|00000060| 6a                                              |j               |
+--------+-------------------------------------------------+----------------+
14:37:10 [DEBUG] [nioEventLoopGroup-2-1] i.n.h.l.LoggingHandler - [id: 0xf0f347b8, L:/192.168.0.103:49979 - R:/192.168.0.103:9090] FLUSH
```



æœåŠ¡ç«¯è¾“å‡º

```
14:36:50 [DEBUG] [main] c.i.n.HelloWorldServer - [id: 0xdff439d3] binding...
14:36:51 [DEBUG] [main] c.i.n.HelloWorldServer - [id: 0xdff439d3, L:/192.168.0.103:9090] bound...
14:37:10 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0x744f2b47, L:/192.168.0.103:9090 - R:/192.168.0.103:49979] REGISTERED
14:37:10 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0x744f2b47, L:/192.168.0.103:9090 - R:/192.168.0.103:49979] ACTIVE
14:37:10 [DEBUG] [nioEventLoopGroup-3-1] c.i.n.HelloWorldServer - connected [id: 0x744f2b47, L:/192.168.0.103:9090 - R:/192.168.0.103:49979]
14:37:10 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0x744f2b47, L:/192.168.0.103:9090 - R:/192.168.0.103:49979] READ: 9B
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 61 61 61 61 61 61 61 61 61                      |aaaaaaaaa       |
+--------+-------------------------------------------------+----------------+
14:37:10 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0x744f2b47, L:/192.168.0.103:9090 - R:/192.168.0.103:49979] READ: 9B
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 62 62 62 62 62 62 62 62 62                      |bbbbbbbbb       |
+--------+-------------------------------------------------+----------------+
14:37:10 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0x744f2b47, L:/192.168.0.103:9090 - R:/192.168.0.103:49979] READ: 6B
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 63 63 63 63 63 63                               |cccccc          |
+--------+-------------------------------------------------+----------------+
14:37:10 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0x744f2b47, L:/192.168.0.103:9090 - R:/192.168.0.103:49979] READ: 8B
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 64 64 64 64 64 64 64 64                         |dddddddd        |
+--------+-------------------------------------------------+----------------+
14:37:10 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0x744f2b47, L:/192.168.0.103:9090 - R:/192.168.0.103:49979] READ: 15B
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 65 65 65 65 65 65 65 65 65 65 65 65 65 65 65    |eeeeeeeeeeeeeee |
+--------+-------------------------------------------------+----------------+
14:37:10 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0x744f2b47, L:/192.168.0.103:9090 - R:/192.168.0.103:49979] READ: 13B
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 66 66 66 66 66 66 66 66 66 66 66 66 66          |fffffffffffff   |
+--------+-------------------------------------------------+----------------+
14:37:10 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0x744f2b47, L:/192.168.0.103:9090 - R:/192.168.0.103:49979] READ: 2B
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 67 67                                           |gg              |
+--------+-------------------------------------------------+----------------+
14:37:10 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0x744f2b47, L:/192.168.0.103:9090 - R:/192.168.0.103:49979] READ: 2B
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 68 68                                           |hh              |
+--------+-------------------------------------------------+----------------+
14:37:10 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0x744f2b47, L:/192.168.0.103:9090 - R:/192.168.0.103:49979] READ: 14B
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 69 69 69 69 69 69 69 69 69 69 69 69 69 69       |iiiiiiiiiiiiii  |
+--------+-------------------------------------------------+----------------+
14:37:10 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0x744f2b47, L:/192.168.0.103:9090 - R:/192.168.0.103:49979] READ: 9B
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 6a 6a 6a 6a 6a 6a 6a 6a 6a                      |jjjjjjjjj       |
+--------+-------------------------------------------------+----------------+
14:37:10 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0x744f2b47, L:/192.168.0.103:9090 - R:/192.168.0.103:49979] READ COMPLETE

```

#### 2.åè®®

##### è‡ªå®šä¹‰åè®®

è¦ç´ 

* é­”æ•°ï¼Œç”¨æ¥åœ¨ç¬¬ä¸€æ—¶é—´åˆ¤å®šæ˜¯å¦æ˜¯æ— æ•ˆæ•°æ®åŒ…

* ç‰ˆæœ¬å·ï¼Œå¯ä»¥æ”¯æŒåè®®çš„å‡çº§

* åºåˆ—åŒ–ç®—æ³•ï¼Œæ¶ˆæ¯æ­£æ–‡åˆ°åº•é‡‡ç”¨å“ªç§åºåˆ—åŒ–ååºåˆ—åŒ–æ–¹å¼ï¼Œå¯ä»¥ç”±æ­¤æ‰©å±•ï¼Œä¾‹å¦‚ï¼šjsonã€protobufã€hessianã€jdk

  [^protobufã€hessian]: åŸºäºäºŒè¿›åˆ¶

* æŒ‡ä»¤ç±»å‹ï¼Œæ˜¯ç™»å½•ã€æ³¨å†Œã€å•èŠã€ç¾¤èŠ... è·Ÿä¸šåŠ¡ç›¸å…³

* è¯·æ±‚åºå·ï¼Œä¸ºäº†åŒå·¥é€šä¿¡ï¼Œæä¾›å¼‚æ­¥èƒ½åŠ›

* æ­£æ–‡é•¿åº¦

* æ¶ˆæ¯æ­£æ–‡

